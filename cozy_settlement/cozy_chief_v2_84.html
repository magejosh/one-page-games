<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cozy Chief ‚Äî v2.84 (Deep Tech Tree & Fantasy)</title>
<style>
:root{
  --bg:#0e1222; --panel:#151b2e; --panel2:#1b2340; --line:#2a335a; --ink:#e9eeff; --muted:#b7c2ff;
  --good:#91e1a1; --warn:#ffd079; --bad:#ff9aa0; --accent:#88c2ff; --accent2:#a7d6ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; color:var(--ink);
     background: radial-gradient(1100px 520px at 65% -10%, rgba(255,255,255,.07), transparent 60%), linear-gradient(180deg,#0a0f1f,#0f1531);}
header,footer{padding:10px 12px; background:linear-gradient(180deg,var(--panel),var(--panel2)); border-top:1px solid var(--line); border-bottom:1px solid var(--line)}
.wrap{display:grid; grid-template-rows:auto 1fr auto; height:100%}
.row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
#resRow{display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:8px 12px;}
@media (max-width:900px){
  #resRow{grid-template-columns:repeat(auto-fit,minmax(80px,1fr));}
  #resRow .small{display:none;}
}
.pill{background:#0c1125; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-weight:800}
/* Keep resource pills on one line (emoji, count, key) */
#resRow .pill{display:inline-flex; align-items:center; gap:6px; white-space:nowrap; min-width:max-content}
.small{font-size:12px; color:#c8d2ff}
.grid{display:grid; grid-template-columns: 320px 1fr 260px; gap:10px; padding:10px}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:12px; padding:10px; overflow:auto}
h2{margin:4px 0 8px; font-size:18px}
.btn{background:#232b4d; border:1px solid var(--line); color:var(--ink); padding:8px 10px; border-radius:10px; font-weight:800; cursor:pointer}
.btn:hover{filter:brightness(1.08)}
.btn[disabled]{opacity:.5; cursor:not-allowed}
.select{background:#0e1430; border:1px solid var(--line); color:var(--ink); border-radius:10px; padding:6px 10px; font-weight:700}
.bcard{border:1px solid var(--line); border-radius:12px; background:#0f1432; padding:8px; margin-bottom:6px}
.cost{font-size:12px; color:#cbd4ff}
.flex{display:flex; justify-content:space-between; align-items:center; gap:6px}
.kbd{background:#0a0f22; border:1px solid var(--line); padding:2px 6px; border-radius:6px; font-weight:800}
.badge{display:inline-block; padding:2px 6px; border-radius:6px; background:#26305a; border:1px solid #36407a}
/* Map */
.mapWrap{display:block;}
.viewport{position:relative; background:linear-gradient(180deg,#132147,#0f1636); border:1px solid var(--line); border-radius:12px; overflow:hidden; min-height:520px; cursor:grab}
.viewport.dragging{cursor:grabbing}
#map{position:absolute; left:0; top:0; transform-origin: top left;}
.tile{position:absolute; width:40px; height:40px; border:1px solid #2f3a66; border-radius:6px;
      display:flex; align-items:center; justify-content:center; font-size:18px; color:#e9f2ff;
      background:linear-gradient(180deg,#17264b,#15213f); user-select:none; pointer-events:auto}
#avatar,.critter{position:absolute; width:40px; height:40px; display:flex; align-items:center; justify-content:center;}
.critter{font-size:20px;}
#avatar{position:absolute; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:18px; pointer-events:none; z-index:5}
.tile .l{position:absolute; right:4px; bottom:4px; font-size:10px; opacity:.85; color:#d8e1ff}
.tile .grow{position:absolute; top:2px; left:2px; font-size:12px}
#hl{position:absolute; border:2px dashed #9bd0ff; border-radius:8px; pointer-events:none; display:none}
.placing .tile:hover{border:2px dashed #9bd0ff; background:rgba(152,206,255,.1)}
.minimap{background:#0f1430; border:1px solid var(--line); border-radius:10px; height:160px; position:relative; cursor:pointer}
#miniCanvas{width:100%; height:100%}
.viewRect{position:absolute; border:2px solid #9bd0ff; box-shadow:0 0 6px rgba(152,206,255,.7) inset; pointer-events:none}
/* Log */
.log{white-space:pre-wrap; font-size:12px}
.toast{position:fixed; right:12px; bottom:12px; background:#0f1430; border:1px solid var(--line); border-radius:10px; padding:10px 12px; display:none}
/* Tech modal */
#techModal{position:fixed; inset:0; background:rgba(7,10,22,.8); display:none; align-items:center; justify-content:center; z-index:30}
.techCard{width:980px; height:640px; background:#0e1430; border:1px solid #2a335a; border-radius:14px; box-shadow:0 20px 80px rgba(0,0,0,.5); display:grid; grid-template-rows:auto 1fr auto}
.techHead{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #2a335a}
.techWrap{position:relative; overflow:auto; background: radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.06), transparent 60%); }
#techCanvas{position:relative; width:1400px; height:900px; margin:12px; }
#techEdges{position:absolute; inset:0; pointer-events:none}
.node{position:absolute; min-width:150px; max-width:200px; padding:8px; border-radius:10px; border:1px solid #3a4472; background:#11173a; box-shadow:0 6px 14px rgba(0,0,0,.2)}
.node h4{margin:0 0 4px; font-size:14px}
.node .desc{font-size:12px; color:#cbd4ff}
.node .cost{font-size:12px; margin-top:6px; color:#dfe6ff}
.node .unlock{font-size:12px; color:#a7ffc7}
.node.owned{border-color:#3e7a57; background:#112a1e}
.node.available{border-color:#7aa0ff; box-shadow:0 0 0 2px rgba(122,160,255,.2)}
.node.locked{opacity:.6}
.node button{margin-top:6px}
.techFoot{display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-top:1px solid #2a335a}
/* Event modal */
#eventModal{position:fixed; inset:0; background:rgba(7,10,22,.8); display:none; align-items:center; justify-content:center; z-index:35}
.eventCard{width:700px; background:#0e1430; border:1px solid #2a335a; border-radius:14px; box-shadow:0 20px 80px rgba(0,0,0,.5); display:grid; grid-template-rows:auto 1fr auto}
.eventHead{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #2a335a}
.eventBody{padding:12px; overflow:auto}
.eventFoot{display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-top:1px solid #2a335a}
/* Scout pings */
.ping{position:absolute; width:40px; height:40px; border-radius:50%; border:2px solid #88c2ff; opacity:0; pointer-events:none; z-index:7; animation: ping 1.3s ease-out forwards;}
@keyframes ping{0%{opacity:.9; transform:scale(.6)} 100%{opacity:0; transform:scale(2.2)}}
/* Node glow */
.glow{position:absolute; width:40px; height:40px; border-radius:10px; box-shadow:0 0 12px 6px rgba(136,194,255,.45); opacity:.95; pointer-events:none; z-index:6; animation: glow 2.5s ease-out 2 forwards;}
@keyframes glow{0%{opacity:.95} 100%{opacity:0; box-shadow:0 0 24px 0 rgba(136,194,255,.0)}}
</style>
<style>
/* Delivery courier */
.courier{position:absolute; width:40px; height:40px; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:6; transition: transform 2s linear;}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div id="resRow" class="row"></div>
  <div class="row" style="gap:14px; margin-top:6px">
    <span class="pill">Leader: <b>Cozy Chief</b></span>
    <span class="pill">Tier <b id="tier">Hamlet I</b></span>
    <span id="tierNext" class="small"></span>
    <span class="pill">Day <b id="day">1</b></span>
    <span class="pill">Season <b id="season">Spring</b></span>
    <span class="pill">Time <b id="clock">06:00</b></span>
    <span class="pill">Happiness <b id="happy">100%</b></span>
    <span class="pill" id="heroBadge" style="display:none">Hero: <b id="heroTime">00:00</b></span>
    <span id="victoryPill" class="pill" style="display:none">Victory: <b id="victoryText"></b></span>
    <label class="pill">Speed
      <select id="speed" class="select">
        <option value="0">Pause</option>
        <option value="0.5">0.5√ó</option>
        <option value="1" selected>1√ó</option>
        <option value="2">2√ó</option>
        <option value="4">4√ó</option>
      </select>
    </label>
    <span id="placingText" class="small"></span>
    <span class="small">Move: WASD/Arrows ¬∑ Zoom: Wheel ¬∑ Pan: Drag ¬∑ Place: click tile ¬∑ Cancel: <span class="kbd">Esc</span></span>
  </div>
</header>

<div class="grid">
  <aside class="panel">
    <h2>Actions</h2>
    <div class="row" style="gap:8px; flex-wrap:wrap">
      <button id="gWood" class="btn">üå≤ Forage Wood<br><span class="small">+5 wood ¬∑ 3s</span></button>
      <button id="gFood" class="btn">üçì Forage Berries<br><span class="small">+5 food ¬∑ 3s</span></button>
      <button id="gStone" class="btn">üóø Scavenge Stone<br><span class="small">+3 stone ¬∑ 5s</span></button>
      <button id="gClay" class="btn">üß± Dig Clay<br><span class="small">+3 clay ¬∑ 5s</span></button>
      <button id="gFlax" class="btn">üåø Gather Flax<br><span class="small">+2 flax ¬∑ 6s</span></button>
      <button id="recruit" class="btn">üë™ Recruit Villager<br><span class="small">-30 food ¬∑ 10s</span></button>
    </div>
    <h2 style="margin-top:10px">Build</h2>
    <div id="buildList"></div>
  </aside>

  <main class="panel">
    <div class="mapWrap">
      <div class="viewport" id="viewport">
        <div id="map"></div>
      </div>
      <button id="gMana" class="btn">üîÆ Harvest Crystals<br><span class="small">+1 mana ¬∑ 6s</span></button>
      <button id="scout" class="btn">üß≠ Scout<br><span class="small">Reveal rare nodes ¬∑ 15s</span></button>
      <button id="hero" class="btn">üõ°Ô∏è Host Hero<br><span class="small">-50 gold, -20 food ¬∑ 20s</span></button>
    </div>
    <div id="tileInfo" class="small" style="margin-top:6px"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px">
      <section class="bcard">
        <div class="small"><b>Milestones</b> ‚Äî goals that grant rewards</div>
        <div id="quests"></div>
      </section>
      <section class="bcard">
        <div class="small"><b>Journal</b></div>
        <div id="log" class="log"></div>
      </section>
      <section class="bcard">
        <div class="small"><b>Policies</b> ‚Äî long-tail modifiers</div>
        <div id="policies" class="small"></div>
      </section>
    </div>
  </main>

  <aside class="panel">
    <h2>Minimap</h2>
    <div class="minimap">
      <canvas id="miniCanvas" width="160" height="160"></canvas>
      <div id="miniView" class="viewRect"></div>
    </div>
    <div class="bcard" style="margin-top:10px">
      <div class="small"><b>Tech & Culture</b></div>
      <div class="small">Spend üìú Knowledge to steer your <b>fantasy medieval</b> village‚Äôs path.</div>
      <div class="row" style="gap:6px; margin-top:6px">
         <button class="btn" id="btnTechTree">Open Tech Tree</button>
         <button class="btn" id="btnDiscovery">Surprise Discovery</button>
      </div>
      <div id="techActive" class="small" style="margin-top:6px"></div>
    </div>
    <h2 style="margin-top:12px">Planner</h2>
    <div id="planner" class="small">Select a building to enter placement mode, then click a tile on the map.</div>
    <h2>Settings</h2>
    <button id="reset" class="btn">Reset Game</button>
  </aside>
</div>

<footer>
  <div class="small">Cozy Chief v2.84 ‚Äî Deeper tech tree, lumber upgrades, terrain, and critters.</div>
  <div class="small" id="govPolSummary"></div>
</footer>

<div id="toast" class="toast"></div>

<!-- Tech Modal -->
<div id="techModal">
  <div class="techCard">
    <div class="techHead">
      <div><b>Tech Tree ‚Äî Fantasy Medieval</b> <span class="small">Click a node to research with üìú Knowledge.</span></div>
      <button id="techClose" class="btn">Close</button>
    </div>
    <div class="techWrap">
      <svg id="techEdges" width="1400" height="900"></svg>
      <div id="techCanvas"></div>
    </div>
    <div class="techFoot small">
      <div>Owned: <span id="ownedCount">0</span> ¬∑ Knowledge: <span id="knCur">0</span></div>
      <div>Tip: You can also roll a <b>Surprise Discovery</b> from the right panel.</div>
    </div>
  </div>
</div>

<!-- Event Modal -->
<div id="eventModal">
  <div class="eventCard">
    <div class="eventHead">
      <div id="eventTitle"><b>Council Event</b></div>
      <button id="eventClose" class="btn">Decide later</button>
    </div>
    <div class="eventBody">
      <div id="eventText" class="small" style="margin-bottom:8px"></div>
      <div id="eventChoices"></div>
    </div>
    <div class="eventFoot small">
      <div>Choices may have uncertain outcomes.</div>
      <div id="eventHint"></div>
    </div>
  </div>
  
</div>

<script>
// ===== helpers
const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const fmt=n=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':Math.floor(n);
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1400); }
function log(msg){ const el=$('#log'); const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); el.textContent='['+time+'] '+msg+'\\n'+el.textContent; }

// ===== data
const RES=["wood","stone","food","gold","clay","flax","linen","iron","tools","mana","hide","housing","pop","faith","knowledge","culture"];
const EM={wood:"üå≤",stone:"üóø",food:"üçû",gold:"üí∞",clay:"üß±",flax:"üåø",linen:"üßµ",iron:"‚õìÔ∏è",tools:"üõ†Ô∏è",mana:"üîÆ",hide:"ü¶å",housing:"üè†",pop:"üë™",faith:"‚õ™",knowledge:"üìú",culture:"üé∂"};
// Extend resources with meat (between hide and housing)
try{
  if(typeof RES!=='undefined' && Array.isArray(RES)){
    if(!RES.includes('meat')){ const i=RES.indexOf('hide'); if(i>=0) RES.splice(i+1,0,'meat'); else RES.push('meat'); }
  }
  if(typeof EM!=='undefined'){ EM.meat='üçñ'; }
}catch(e){}
const NODES=[
  {k:'tree',em:'üå≤',gain:{wood:5},amt:[20,40]},
  {k:'berry',em:'üçì',gain:{food:5},amt:[15,30]},
  {k:'stone',em:'üóø',gain:{stone:3},amt:[12,24]},
  {k:'clay',em:'üß±',gain:{clay:3},amt:[12,24]},
  {k:'flax',em:'üåø',gain:{flax:2},amt:[10,20]},
];
const WORLD_W=48, WORLD_H=30, CELL=40;
const SEASONS=[{name:"Spring",farm:1.15},{name:"Summer",farm:1.25},{name:"Autumn",farm:1.05},{name:"Winter",farm:0.6}];
const BUILD=[
  {k:"chief",name:"Chief‚Äôs Longhouse",ic:"üè∞",desc:"Unique hall of leadership; occasional üìú from your people.",cost:{wood:30,stone:10},unique:true},
  {k:"woodhut",name:"Woodcutter Hut",ic:"ü™ì",desc:"Produces wood.",cost:{wood:15},prod:{wood:1.2}},
  {k:"lumbermill",name:"Lumber Mill",ic:"üè≠",desc:"Advanced wood production.",cost:{wood:60,stone:40},prod:{wood:2.5},need:"Forestry"},
  {k:"farm",name:"Wheat Farm",ic:"üåæ",desc:"Produces food (seasonal).",cost:{wood:20},prod:{food:0.9}},
  {k:"cottage",name:"Cottage",ic:"üèöÔ∏è",desc:"+3 housing.",cost:{wood:35,stone:12},house:3},
  {k:"townhouse",name:"Townhouse",ic:"üèòÔ∏è",desc:"+6 housing.",cost:{wood:90,stone:80,gold:50},house:6,need:"Architecture"},
  {k:"quarry",name:"Stone Quarry",ic:"‚õèÔ∏è",desc:"Slow stone; rare iron/gold finds.",cost:{wood:40,stone:15},prod:{stone:3.0}},
  {k:"claypit",name:"Clay Pit",ic:"üß±",desc:"Digs clay.",cost:{wood:25},prod:{clay:0.6}},
  {k:"loom",name:"Loom",ic:"üßµ",desc:"Turns flax ‚ûú linen.",cost:{wood:45,clay:20},use:{flax:0.5},prod:{linen:0.4},need:"Weaving"},
  {k:"flaxfield",name:"Flax Field",ic:"üåø",desc:"Grows flax.",cost:{wood:20},prod:{flax:0.6},need:"Weaving"},
  {k:"mine",name:"Iron Mine",ic:"‚õèÔ∏è",desc:"Extracts iron ore.",cost:{wood:50,stone:40},prod:{iron:0.5},need:"Masonry"},
  {k:"workshop",name:"Workshop",ic:"üõ†Ô∏è",desc:"Iron + wood ‚ûú tools.",cost:{wood:60,stone:30,iron:10},use:{iron:0.4, wood:0.2},prod:{tools:0.3},need:"Crafting"},
  {k:"bakery",name:"Bakery",ic:"ü•ê",desc:"Food ‚ûú gold.",cost:{wood:50,stone:30},use:{food:0.7},prod:{gold:0.4}},
  {k:"inn",name:"Inn",ic:"üçª",desc:"Raises happiness & culture.",cost:{wood:70,stone:50,gold:40},mood:+0.3,prod:{culture:0.2}},
  {k:"shrine",name:"Wayside Shrine",ic:"üïØÔ∏è",desc:"Generates faith.",cost:{wood:60,stone:80},prod:{faith:0.25},need:"Spirituality"},
  {k:"school",name:"Village School",ic:"üè´",desc:"Steady üìú knowledge.",cost:{wood:90,stone:90,clay:40},prod:{knowledge:0.35},need:"Learning"},
  {k:"market",name:"Market",ic:"üè¶",desc:"Gold based on population and culture.",cost:{wood:70,stone:90,linen:20},prod:{gold:0},need:"Trade Guilds"},
  {k:"tower",name:"Guard Tower",ic:"üõ°Ô∏è",desc:"Trains guards to defend nearby.",cost:{wood:80,stone:60},need:"Guard Towers"},
  {k:"guild",name:"Adventurers Guild",ic:"‚öîÔ∏è",desc:"Trains adventurers to clear dungeons.",cost:{wood:100,stone:80,gold:50},need:"Dungeoneering"},
];
// Extend BUILD with hunting/tanning/butchery line
try{
  BUILD.push(
    {k:"wheatfield",name:"Wheat Field",ic:"üåæ",desc:"Grows grain near farms.",cost:{wood:10},prod:{food:0.2},need:"Farming"},
    {k:"ranch",name:"Ranch",ic:"üêÑ",desc:"Raises livestock for meat & hides.",cost:{wood:50,stone:20},prod:{meat:0.4,hide:0.2},need:"Beast Taming"},
    {k:"hunterlodge",name:"Hunters Lodge",ic:"üèπ",desc:"Trains a hunter to track animals.",cost:{wood:60,stone:30},need:"Hunting"},
    {k:"tanner",name:"Tanner",ic:"üß¥",desc:"Converts hides; boosts hunted yields.",cost:{wood:50,stone:40},need:"Tanning"},
    {k:"butcher",name:"Butcher",ic:"üî™",desc:"Turns meat into meals.",cost:{wood:40,stone:30},use:{meat:0.5},prod:{food:0.8},need:"Butchery"},
    {k:"blacksmith",name:"Blacksmith",ic:"‚öíÔ∏è",desc:"Advanced tools from iron.",cost:{wood:60,stone:40,iron:10},use:{iron:0.5},prod:{tools:0.6},need:"Blacksmithing"}
  );
}catch(e){}
const TIERS=[
  {name:"Hamlet I", need:{}},
  {name:"Village II", need:{pop:10, food:120}},
  {name:"Market Town III", need:{pop:20, gold:200, culture:40}},
  {name:"Borough IV", need:{pop:35, knowledge:250}},
  {name:"City V", need:{pop:50, gold:500, knowledge:400}},
  {name:"Metropolis VI", need:{pop:80, gold:1000, culture:200}},
];

// Tech tree nodes
const TECH = [
  {id:"founding", name:"Founding Lore", cost:0, desc:"Traditions of hearth & clan.", prereq:[], unlocks:[]},
  {id:"weaving", name:"Weaving", cost:40, desc:"Spin flax with spindle & loom.", prereq:["founding"], unlocks:["flaxfield","loom"]},
  {id:"masonry", name:"Masonry", cost:40, desc:"Stonecraft, mortar, true arches.", prereq:["founding"], unlocks:[], effect:"mine_discount,stone_foraging"},
  {id:"spirituality", name:"Spirituality", cost:40, desc:"Shrines, rites, wandering monks.", prereq:["founding"], unlocks:["shrine"], effect:"happiness"},
  {id:"learning", name:"Learning", cost:50, desc:"Scribes, slates & lorekeepers.", prereq:["founding"], unlocks:["school"], effect:"wood_bonus"},
  {id:"exploration", name:"Exploration", cost:40, desc:"Scouts chart the unknown.", prereq:["founding"], unlocks:[], effect:"avatar_speed"},
  {id:"forestry", name:"Forestry", cost:50, desc:"Saws and timber lore.", prereq:["founding"], unlocks:["lumbermill"], effect:"wood_bonus2"},
  {id:"crafting", name:"Crafting", cost:60, desc:"Bellows, anvils, better tools.", prereq:["masonry"], unlocks:["workshop"], effect:"tool_bonus"},
  {id:"trade", name:"Trade Guilds", cost:60, desc:"Guild charters & market rights.", prereq:["masonry"], unlocks:["market"], effect:"inn_culture_bonus"},
  {id:"stone_roads", name:"Stone Roads", cost:80, desc:"Milestone roads bind the realm.", prereq:["masonry"], unlocks:[], effect:"all_prod_bonus"},
  {id:"brewcraft", name:"Brewcraft", cost:80, desc:"Malt, yeast, and alewives.", prereq:["trade"], unlocks:[], effect:"bakery_bonus"},
  {id:"council", name:"Governing Council", cost:100, desc:"Elders & charters guide growth.", prereq:["learning","trade"], unlocks:[], effect:"cottage_bonus"},
  {id:"architecture", name:"Architecture", cost:80, desc:"Plans for grand homes.", prereq:["masonry"], unlocks:["townhouse"], effect:"housing_bonus"},
  {id:"beasts", name:"Beast Taming", cost:60, desc:"Track and domesticate wildlife.", prereq:["exploration"], unlocks:[], effect:"hide_bonus"},
  {id:"guard_tower", name:"Guard Towers", cost:80, desc:"Watch posts against monsters.", prereq:["beasts"], unlocks:["tower"]},
  {id:"dungeoneering", name:"Dungeoneering", cost:100, desc:"Brave souls delve below.", prereq:["guard_tower"], unlocks:["guild"]},
  // New branches
  {id:"engineering", name:"Engineering", cost:90, desc:"Mills, bridges, devices.", prereq:["masonry"], unlocks:[], effect:"prod_small"},
  {id:"bridges", name:"Bridges", cost:100, desc:"Span rivers and moats.", prereq:["engineering"], unlocks:[], effect:"speed_small"},
  {id:"waterworks", name:"Waterworks", cost:110, desc:"Mills and canals.", prereq:["engineering"], unlocks:[], effect:"farm_bonus"},
  {id:"seafaring", name:"Seafaring", cost:110, desc:"Coastal trade routes.", prereq:["trade"], unlocks:[], effect:"gold_bonus"},
  {id:"naval_logistics", name:"Naval Logistics", cost:160, desc:"Ports, ledgers, and convoys.", prereq:["seafaring"], unlocks:[], effect:"sea_gold2"},
  {id:"civics", name:"Civics", cost:120, desc:"Institutions and law.", prereq:["council"], unlocks:[], effect:"house_culture"},
  {id:"public_works", name:"Public Works", cost:160, desc:"Road crews and aqueducts.", prereq:["civics","engineering"], unlocks:[], effect:"cost_discount"},
  {id:"legal_reforms", name:"Legal Reforms", cost:180, desc:"Codified rights and duties.", prereq:["civics","learning"], unlocks:[], effect:"law_knowledge"},
  {id:"arcana", name:"Arcana", cost:120, desc:"Tap into mana flows.", prereq:["dungeoneering"], unlocks:[], effect:"mana_gain"},
  {id:"wizardry", name:"Wizardry", cost:140, desc:"Schools for the gifted.", prereq:["arcana"], unlocks:[], effect:"mana_prod"},
  {id:"enchanting", name:"Enchanting", cost:160, desc:"Imbue tools with power.", prereq:["wizardry"], unlocks:[], effect:"tool_bonus2"},
  {id:"runecraft", name:"Runecraft", cost:180, desc:"Ancient stones whisper.", prereq:["enchanting"], unlocks:[], effect:"faith_bonus"},
  {id:"astronomy", name:"Astronomy", cost:200, desc:"Chart stars for omens.", prereq:["guard_tower","brewcraft"], unlocks:[], effect:"knowledge_bonus"},
  {id:"grand_council", name:"Grand Council", cost:220, desc:"Rule of wise elders.", prereq:["astronomy"], unlocks:[], effect:"all_prod_bonus2"},
  {id:"realm_magic", name:"Realm Magic", cost:240, desc:"Bend reality lightly.", prereq:["grand_council"], unlocks:[], effect:"mana_prod2"},
  {id:"dragon_lore", name:"Dragon Lore", cost:260, desc:"Understand winged terrors.", prereq:["beasts"], unlocks:[], effect:"hide_bonus2"},
  {id:"sky_fleet", name:"Sky Fleet", cost:280, desc:"Sail the clouds.", prereq:["dragon_lore"], unlocks:[], effect:"all_prod_bonus3"},
  {id:"mystic_order", name:"Mystic Order", cost:300, desc:"Unified magical guilds.", prereq:["dragon_lore","runecraft","holy_magic"], unlocks:[], effect:"mana_prod3"},
  {id:"planar_gates", name:"Planar Gates", cost:320, desc:"Open portals afar.", prereq:["mystic_order"], unlocks:[], effect:"knowledge_bonus2"},
  {id:"theology", name:"Theology", cost:140, desc:"Doctrine and catechism.", prereq:["spirituality"], unlocks:[], effect:"faith_bonus"},
  {id:"holy_magic", name:"Holy Magic", cost:200, desc:"Miracles and relics.", prereq:["theology"], unlocks:[], effect:"faith_bonus2"},
  {id:"eternal_peace", name:"Eternal Peace", cost:340, desc:"Harmony with beasts.", prereq:["planar_gates"], unlocks:[], effect:"happy_bonus"},
  {id:"divine_right", name:"Divine Right", cost:360, desc:"Rule by celestial mandate.", prereq:["holy_magic"], unlocks:[], effect:"culture_bonus"},
  {id:"cosmic_insight", name:"Cosmic Insight", cost:380, desc:"Truth of stars.", prereq:["arcana","astronomy","eternal_peace","divine_right"], unlocks:[], effect:"mana_prod4"},
  {id:"chronomancy", name:"Chronomancy", cost:400, desc:"Time is malleable.", prereq:["cosmic_insight"], unlocks:[], effect:"speed_bonus"},
  {id:"utopia", name:"Utopia", cost:420, desc:"Perfect society.", prereq:["chronomancy"], unlocks:[], effect:"victory"},
  {id:"ascension", name:"Ascension", cost:440, desc:"Transcendence.", prereq:["utopia"], unlocks:[], effect:"win"},
  // Government choices (mutually exclusive)
  {id:"gov_monarchy", name:"Monarchy", cost:140, desc:"Crown unifies authority.", prereq:["architecture","civics"], unlocks:[], effect:"gov_monarchy"},
  {id:"gov_republic", name:"Council Republic", cost:140, desc:"Councils guide policy.", prereq:["civics","trade"], unlocks:[], effect:"gov_republic"},
  {id:"gov_theocracy", name:"Theocracy", cost:140, desc:"Faith directs rule.", prereq:["civics","spirituality"], unlocks:[], effect:"gov_theocracy"},
  {id:"gov_league", name:"Merchant League", cost:140, desc:"Guilds hold sway.", prereq:["trade","architecture"], unlocks:[], effect:"gov_league"},
  {id:"gov_gerontocracy", name:"Gerontocracy", cost:140, desc:"Elders rule by wisdom.", prereq:["council","learning"], unlocks:[], effect:"gov_gerontocracy"},
  {id:"gov_shamanism", name:"Shamanism", cost:140, desc:"Spirits and signs.", prereq:["spirituality","beasts"], unlocks:[], effect:"gov_shamanism"},
  {id:"gov_meritocracy", name:"Meritocracy", cost:160, desc:"Earned authority.", prereq:["civics","learning"], unlocks:[], effect:"gov_meritocracy"},
  {id:"gov_military", name:"Military Dictatorship", cost:160, desc:"Order through strength.", prereq:["guard_tower","civics"], unlocks:[], effect:"gov_military"},
  {id:"gov_magocracy", name:"Magocracy", cost:180, desc:"Mages in council.", prereq:["wizardry","civics"], unlocks:[], effect:"gov_magocracy"},
  // Victory paths (require resources via reqRes)
  {id:"cultural_victory", name:"Cultural Triumph", cost:0, desc:"Your arts inspire the world.", prereq:["divine_right","grand_council"], unlocks:[], effect:"victory", reqRes:{culture:1000, gold:300}},
  {id:"religious_victory", name:"Sacred Covenant", cost:0, desc:"Faith unites your realm.", prereq:["holy_magic","eternal_peace"], unlocks:[], effect:"victory", reqRes:{faith:800, culture:300}},
  {id:"economic_victory", name:"Trade Hegemony", cost:0, desc:"Commerce bows to your coin.", prereq:["gov_league","sky_fleet"], unlocks:[], effect:"victory", reqRes:{gold:5000}},
  {id:"scientific_victory", name:"Scientific Enlightenment", cost:0, desc:"Knowledge remakes society.", prereq:["cosmic_insight","mystic_order"], unlocks:[], effect:"victory", reqRes:{knowledge:1200, mana:50}},
];

// Extend TECH with Farming/Hunting lines and adjust Forestry prereq
try{
  const forestry=TECH.find(t=>t.id==='forestry'); if(forestry) forestry.prereq=['farming'];
  const beasts=TECH.find(t=>t.id==='beasts'); if(beasts){ beasts.unlocks=(beasts.unlocks||[]).concat(['ranch']); }
  const added=[
    {id:"farming", name:"Farming", cost:40, desc:"Cultivate fields and barns.", prereq:["founding"], unlocks:["farm","wheatfield"]},
    {id:"hunting", name:"Hunting", cost:60, desc:"Bows, traps, and lodges.", prereq:["exploration"], unlocks:["hunterlodge"]},
    {id:"tanning", name:"Tanning", cost:70, desc:"Cures and leathers.", prereq:["beasts"], unlocks:["tanner"]},
    {id:"butchery", name:"Butchery", cost:70, desc:"Cuts and preservation.", prereq:["hunting"], unlocks:["butcher"]},
    {id:"blacksmithing", name:"Blacksmithing", cost:80, desc:"Forge hammers and gear.", prereq:["crafting"], unlocks:["blacksmith"]},
  ];
  added.forEach(t=>{ if(!TECH.find(x=>x.id===t.id)) TECH.push(t); });
}catch(e){}
let TECH_POS_MAP = {};
function computeTechPositions(){
  const techById = Object.fromEntries(TECH.map(t=>[t.id,t]));
  const depthCache = {};
  const depth = id => {
    if(depthCache[id]!==undefined) return depthCache[id];
    const node = techById[id];
    if(!node.prereq.length) return depthCache[id]=0;
    const d = Math.max(...node.prereq.map(depth))+1;
    return depthCache[id]=d;
  };
  const layers = [];
  TECH.forEach(t=>{ const d=depth(t.id); (layers[d]=layers[d]||[]).push(t); });
  const xSpacing=260, ySpacing=160, startX=80, startY=80;
  layers.forEach((layer,d)=>{ layer.forEach((t,i)=>{ TECH_POS_MAP[t.id]=[startX+d*xSpacing,startY+i*ySpacing]; }); });
}
computeTechPositions();

// seeded rng
let seedStr=new URLSearchParams(location.search).get('seed')||prompt('World seed?','')||Math.random().toString(36).slice(2);
let seed=0; for(let i=0;i<seedStr.length;i++) seed=(seed*31+seedStr.charCodeAt(i))|0;
function rng(){ seed^=seed<<13; seed^=seed>>>17; seed^=seed<<5; return (seed>>>0)/4294967296; }

// ===== state
const TERRAIN=[
  {k:'plains',color:'#3a6b35'},
  {k:'forest',color:'#1e4422'},
  {k:'hill',color:'#82693d'},
  {k:'water',color:'#2a4c8d'}
];
// simple deterministic hash for consistent noise per tile
function noise2d(x,y){
  let s=x*374761393 + y*668265263 + seed*31;
  s=(s^(s>>13))*1274126177;
  return ((s^(s>>16))>>>0)/4294967296;
}
let oceanWidths=[];
const OCEAN_MAX_DEPTH=3+(rng()*3|0);

function randTerrain(x,y){
  const r=noise2d(x+1000,y+1000);
  if(r<0.75) return 'plains';
  if(r<0.9) return 'forest';
  return 'hill';
}

function addOcean(){
  for(let y=0;y<WORLD_H;y++){
    const w=1+(rng()*OCEAN_MAX_DEPTH|0);
    oceanWidths[y]=w;
    for(let x=0;x<w;x++) S.tiles[y][x].terrain='water';
  }
}

function addLake(){
  const r=2; let cx,cy;
  do{
    cx=OCEAN_MAX_DEPTH+r+(rng()*(WORLD_W-OCEAN_MAX_DEPTH-2*r)|0);
    cy=r+(rng()*(WORLD_H-2*r)|0);
  }while(S.tiles[cy][cx].terrain==='water');
  for(let y=-r;y<=r;y++){
    for(let x=-r;x<=r;x++){
      if(x*x+y*y<=r*r){ S.tiles[cy+y][cx+x].terrain='water'; }
    }
  }
}

function addRivers(){
  const count=1+(rng()<0.5?0:1);
  for(let i=0;i<count;i++){
    let x=OCEAN_MAX_DEPTH+3+(rng()*(WORLD_W-OCEAN_MAX_DEPTH-3)|0);
    for(let y=0;y<WORLD_H;y++){
      S.tiles[y][x].terrain='water';
      if(x<oceanWidths[y]) break;
      const r=rng();
      if(r<0.6) x--; else if(r<0.8) x++;
      x=clamp(x,0,WORLD_W-1);
    }
  }
}

function smoothBiomes(iter=1){
  const dirs=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];
  for(let t=0;t<iter;t++){
    const copy=S.tiles.map(row=>row.map(c=>c.terrain));
    for(let y=0;y<WORLD_H;y++){
      for(let x=0;x<WORLD_W;x++){
        const cur=copy[y][x]; if(cur==='water') continue;
        const cnt={plains:0,forest:0,hill:0};
        dirs.forEach(([dx,dy])=>{ const nx=x+dx, ny=y+dy; if(nx>=0&&ny>=0&&nx<WORLD_W&&ny<WORLD_H){ const v=copy[ny][nx]; if(v!=='water') cnt[v]++; }});
        const majority = Object.entries(cnt).sort((a,b)=>b[1]-a[1])[0];
        if(majority && majority[1]>=5 && majority[0]!==cur){ S.tiles[y][x].terrain=majority[0]; }
      }
    }
  }
}

const S={
  res:{wood:25, stone:12, food:20, gold:0, clay:0, flax:0, linen:0, iron:0, tools:0, mana:0, hide:0, housing:0, pop:3, faith:0, knowledge:0, culture:0},
  b:{}, tier:0, day:1, secs:6*60, season:0, happy:100,
  speed:1, cam:{x:200,y:200,z:1.0,drag:false,lastX:0,lastY:0},
  tiles:[], place:null, techs: new Set(["Founding Lore"]),
  avatar:{x:24,y:15,spd:1},
  mods:{allMult:1, woodhutMult:1, bakeryGold:1, bakeryFoodUse:1, innCulture:1, cottageBonus:0, mineDiscount:0, stoneForage:1, toolBonus:false, toolNerf:1, manaProd:1, hideBonus:1, knowledgeBonus:1, cultureBonus:1, speedBonus:1, faithBonus:1, popMult:1, seaGold:1, costDiscount:1},
  timers:{chief:0, quarry:0},
  delivery:0,
  terrain:{woodOnForest:0, woodTotal:0, quarryOnHill:0, quarryTotal:0},
  quests:[
    {id:'q_move_gather', text:'Move to a resource and gather once', done:false},
    {id:'q_build_chief', text:'Build the Chief\'s Longhouse', done:false}
  ],
  longhouseLvl:0, // 0=Longhouse,1=Council Hall,2=War Room,3=Great Hall
  eventTimer:0,
  eventOpen:false,
  heroBuffTimer:0,
  gov:null,
  policy:{prod:1, knowledge:1, gold:1, culture:1, faith:1},
  didFirstGather:false,
  growing:false,
};
let lastPop=Math.floor(S.res.pop||0);
BUILD.forEach(b=>S.b[b.k]=0);
for(let y=0;y<WORLD_H;y++){ const row=[]; for(let x=0;x<WORLD_W;x++){ row.push({b:null,res:null,terrain:randTerrain(x,y)}); } S.tiles.push(row); }
addOcean(); addLake(); addRivers(); smoothBiomes(1);
let critters=[];
function randAmt(k){
  const n=NODES.find(n=>n.k===k);
  if(!n){
    if(k==='dungeon') return 1;
    if(k==='crystal') return 8 + (rng()*6|0);
    return 10;
  }
  return Math.floor(n.amt[0]+rng()*(n.amt[1]-n.amt[0]));
}
function scatterNodes(){
  const place=(k,c)=>{
    for(let i=0;i<c;i++){
      let x,y;
      do{ x=rng()*WORLD_W|0; y=rng()*WORLD_H|0; }
      while(S.tiles[y][x].res || S.tiles[y][x].terrain==='water' || (x===S.avatar.x && y===S.avatar.y));
      const amt=randAmt(k);
      S.tiles[y][x].res={k,left:amt,resources:amt,resourceCap:amt};
    }
  };
  place('tree',60); place('berry',40); place('stone',30); place('clay',25); place('flax',20); place('dungeon',3);
}
scatterNodes();

function spawnCritter(){
  const c={x:rng()*WORLD_W|0,y:rng()*WORLD_H|0,type:rng()<0.2?'monster':'animal'};
  const el=document.createElement('div'); el.className='critter';
  el.textContent = c.type==='monster'?'üëæ':'üêá';
  el.style.left=(c.x*CELL)+'px'; el.style.top=(c.y*CELL)+'px';
  c.el=el; mapEl.appendChild(el); critters.push(c);
}
let critterTimer=0;
function updateCritters(dt){
  critterTimer+=dt;
  if(critterTimer>5){ spawnCritter(); critterTimer=0; }
  critters.forEach(c=>{
    if(rng()<0.02){
      const dx=(rng()*3|0)-1, dy=(rng()*3|0)-1;
      c.x=clamp(c.x+dx,0,WORLD_W-1); c.y=clamp(c.y+dy,0,WORLD_H-1);
      c.el.style.left=(c.x*CELL)+'px'; c.el.style.top=(c.y*CELL)+'px';
    }
  });
}

// Override: smarter critters with defenses
function spawnCritter(){
  const towerCnt = S.b.tower||0, guildCnt=S.b.guild||0;
  const base = 0.2; const reduce = 0.15*towerCnt + 0.2*guildCnt; const chance = Math.max(0.02, base*(1-reduce));
  const c={x:rng()*WORLD_W|0,y:rng()*WORLD_H|0,type:rng()<chance?'monster':'animal'};
  const el=document.createElement('div'); el.className='critter';
  el.textContent = c.type==='monster'?'üëæ':'üêá';
  el.style.left=(c.x*CELL)+'px'; el.style.top=(c.y*CELL)+'px';
  c.el=el; mapEl.appendChild(el); critters.push(c);
}
function nearbyDefense(x,y){
  const r=4;
  for(let yy=Math.max(0,y-r); yy<=Math.min(WORLD_H-1,y+r); yy++){
    for(let xx=Math.max(0,x-r); xx<=Math.min(WORLD_W-1,x+r); xx++){
      const b=S.tiles[yy][xx].b; if(b==='tower' || b==='guild') return true;
    }
  }
  return false;
}
const _updateCrittersRaw = updateCritters;
updateCritters = function(dt){
  // call original movement/spawn
  _updateCrittersRaw(dt);
  // defense check clears nearby monsters
  const removed=[];
  critters.forEach((c,i)=>{
    if(c.type==='monster' && nearbyDefense(c.x,c.y)){
      const chance = Math.min(0.9, 0.3*dt + 0.05*(S.b.tower||0) + 0.08*(S.b.guild||0) + 0.05*(S.longhouseLvl>=2?1:0) + (S.gov==='Military'?0.1:0));
      if(Math.random()<chance){
        log('Guards drive off a monster.');
        c.el.remove(); removed.push(i);
      }
    }
  });
  // remove in reverse order
  removed.sort((a,b)=>b-a).forEach(i=>critters.splice(i,1));
}

// ===== UI builders
function buildResourceRow(){
  const row=$('#resRow'); row.innerHTML='';
  RES.forEach(k=>{
    const pill=document.createElement('span'); pill.className='pill';
    const v = S.res[k]||0;
    const disp = k==='pop' ? v.toFixed(1) : Math.floor(v);
    pill.innerHTML = `${EM[k]} <b id="r_${k}">${disp}</b> <span class="small" style="margin-left:4px">${k}</span>`;
    if(k==='pop'){
      pill.id = 'pill_pop';
      pill.title = `${v.toFixed(1)} / ${Math.floor(S.res.housing||0)} housing`;
    }
    row.appendChild(pill);
  });
}
function canUseTech(b){ return !b.need || S.techs.has(b.need); }
function dynCost(bk){
  const base = JSON.parse(JSON.stringify(BUILD.find(x=>x.k===bk).cost));
  if(bk==="mine" && S.mods.mineDiscount>0){ for(const k in base){ base[k]=Math.ceil(base[k]*(1-S.mods.mineDiscount)); } }
  if(S.mods.costDiscount && S.mods.costDiscount!==1){ for(const k in base){ base[k]=Math.ceil(base[k]*S.mods.costDiscount); } }
  return base;
}
function buildBuildList(){
  const list=$('#buildList'); list.innerHTML='';
  BUILD.forEach(b=>{
    if(!canUseTech(b)) return;
    if(b.unique && S.b[b.k]) return;
    const cost = dynCost(b.k);
    const card=document.createElement('div'); card.className='bcard';
    card.innerHTML=`<div class="flex"><div><strong>${b.ic} ${b.name}</strong><div class="small">${b.desc}</div></div><div><b id="cnt_${b.k}">${S.b[b.k]}</b></div></div>
      <div class="cost">Cost: ${Object.entries(cost).map(([k,v])=>`${EM[k]} ${Math.floor(v)}`).join(' ¬∑ ')}</div>
      <div class="flex"><button id="build_${b.k}" class="btn">Place</button><span class="small badge">Click a tile‚Ä¶</span></div>`;
    list.appendChild(card);
  });
  BUILD.forEach(b=>{ const btn=document.getElementById('build_'+b.k); if(btn) btn.addEventListener('click',()=>enterPlacement(b.k)); });
}
function rebuildBuildListForTech(){ buildBuildList(); updateBuildButtons(); }
function enterPlacement(k){
  S.place=k; $('#placingText').textContent='Placing: '+BUILD.find(x=>x.k===k).name;
  $('#planner').textContent='Click a tile to place. Esc to cancel.'; log('Placement mode: '+k);
  mapEl.classList.add('placing');
}
function exitPlacement(msg){
  S.place=null; $('#placingText').textContent=''; if(msg) $('#planner').textContent=msg;
  mapEl.classList.remove('placing');
}

// ===== Map & camera
const mapEl=$('#map'); const vp=$('#viewport');
function mapSize(){ return {w:WORLD_W*CELL, h:WORLD_H*CELL}; }
function ensureMap(){
  if(mapEl.hasChildNodes()) return;
  mapEl.style.width = mapSize().w+'px'; mapEl.style.height = mapSize().h+'px';
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      const t=document.createElement('div'); t.className='tile'; t.style.left=(x*CELL)+'px'; t.style.top=(y*CELL)+'px';
      const cell=S.tiles[y][x];
      const terr=TERRAIN.find(tt=>tt.k===cell.terrain);
      t.style.background=terr.color;
      t.dataset.terrain=cell.terrain;
      t.dataset.x=x; t.dataset.y=y; t.innerHTML='<span class="l"></span>';
      mapEl.appendChild(t);
    }
  }
  const av=document.createElement('div'); av.id='avatar'; av.textContent='üö∂'; mapEl.appendChild(av);
  updateAvatar();
}
function redrawTiles(){
  $$('.tile',mapEl).forEach(el=>{
    const x=+el.dataset.x, y=+el.dataset.y; const cell=S.tiles[y][x];
    if(cell.b){
      const b=BUILD.find(q=>q.k===cell.b);
      let extra='';
      if(S.growing && b.house) extra = '<span class="grow" title="Growing">üë∂</span>';
      el.innerHTML=`<div>${b.ic}</div>${extra}<span class="l">${b.name.split(' ')[0]}</span>`;
    }
    else if(cell.res){
      const n=NODES.find(n=>n.k===cell.res.k);
      const em = n ? n.em : (cell.res.k==='dungeon'?'üè∞':'?');
      el.innerHTML=`<div>${em}</div><span class="l">${cell.res.left}</span>`;
    }
    else el.innerHTML='<span class="l"></span>';
  });
}
function camOffset(){ return {cx:Math.round(S.cam.x), cy:Math.round(S.cam.y)}; }
function applyCam(){ const {cx,cy}=camOffset(); mapEl.style.transform = `translate(${-cx}px, ${-cy}px) scale(${S.cam.z})`; updateMiniViewRect(); }
function screenToWorld(sx,sy){ const r=vp.getBoundingClientRect(); const {cx,cy}=camOffset(); return {wx:(sx-r.left)/S.cam.z + cx, wy:(sy-r.top)/S.cam.z + cy}; }
function worldToTile(wx,wy){ const tx=Math.floor(wx/CELL), ty=Math.floor(wy/CELL); if(tx<0||ty<0||tx>=WORLD_W||ty>=WORLD_H) return null; return {tx,ty}; }
function updateAvatar(){ const av=$('#avatar'); av.style.left=(S.avatar.x*CELL)+'px'; av.style.top=(S.avatar.y*CELL)+'px'; }

function moveAvatar(dx,dy){
  const nx=clamp(S.avatar.x+dx,0,WORLD_W-1), ny=clamp(S.avatar.y+dy,0,WORLD_H-1);
  S.avatar.x=nx; S.avatar.y=ny; S.secs += 1/S.avatar.spd;
  updateAvatar(); updateActionButtons(); updateResAndMeta(); updateBuildButtons();
}

function centerOnAvatar(){
  const vw=vp.clientWidth, vh=vp.clientHeight;
  S.cam.x = S.avatar.x*CELL - vw/2 + CELL/2;
  S.cam.y = S.avatar.y*CELL - vh/2 + CELL/2;
  applyCam();
}
mapEl.addEventListener('click',e=>{
  const crit=e.target.closest('.critter');
  if(crit){
    const idx=critters.findIndex(c=>c.el===crit);
    if(idx>-1){
      const c=critters[idx];
      const dist=Math.abs(S.avatar.x-c.x)+Math.abs(S.avatar.y-c.y);
      if(dist>1){ log('Move closer to engage.'); return; }
      if(c.type==='monster'){ S.res.gold+=20; log('Monster defeated (+20 gold).'); }
      else { S.res.hide+=1; log('Hunted animal (+1 hide).'); }
      crit.remove(); critters.splice(idx,1); updateResAndMeta();
    }
    return;
  }
  const t=e.target.closest('.tile'); if(!t) return; e.stopPropagation();
  const x=+t.dataset.x, y=+t.dataset.y;
  if(S.place){ placeAt(S.place,x,y); return; }
  const cell=S.tiles[y][x];
  if(cell.res){
    const n=NODES.find(n=>n.k===cell.res.k);
    const terrText = S.tiles[y][x].terrain;
    let html = `${(n?n.em:'üè∞')} <b>${cell.res.k}</b><br><span class=\"small\">Remain: ${cell.res.left}</span><br><span class=\"small\">Terrain: ${terrText}</span>`;
    if(cell.res.k==='dungeon'){
      const near = (S.avatar.x===x && S.avatar.y===y);
      const can = (S.b.guild||0)>0;
      html += `<br><span class=\"small\">Requires: Adventurers Guild</span>`;
      html += `<br><button class=\"btn small\" id=\"delve_${x}_${y}\" ${(!can||!near)?'disabled':''}>Delve Dungeon</button>`;
      setTimeout(()=>{ const btn=$('#delve_'+x+'_'+y); if(btn) btn.onclick=()=>delveDungeon(x,y); });
    }
    $('#planner').innerHTML = html;
  } else if(cell.b){
    const b=BUILD.find(q=>q.k===cell.b);
    let html=`${b.ic} <b>${b.name}</b>`;
    const terrText = S.tiles[y][x].terrain;
    html+=`<br><span class="small">Terrain: ${terrText}</span>`;
    if(cell.b==='woodhut' && S.techs.has('Forestry')){
      html+=`<br><button class="btn small" id="upg_${x}_${y}">Upgrade ‚ûú Lumber Mill</button>`;
      setTimeout(()=>{
        const btn=$('#upg_'+x+'_'+y); if(btn) btn.onclick=()=>upgradeWoodhut(x,y);
      });
    }
    if(cell.b==='chief'){
      const lvl=S.longhouseLvl; const names=['Longhouse','Council Hall','War Room','Great Hall'];
      html+=`<br><span class="small">Hall Level: ${names[lvl]}</span>`;
      if(lvl<3){ const next=names[lvl+1]; html+=`<br><button class="btn small" id="upg_hall">Upgrade ‚ûú ${next}</button>`; setTimeout(()=>{ const btn=$('#upg_hall'); if(btn) btn.onclick=upgradeLonghouse; }); }
    }
    $('#planner').innerHTML=html;
  } else {
    $('#planner').textContent='Select a building to enter placement mode, then click a tile on the map.';
  }
});
window.addEventListener('keydown',e=>{
  if(e.key==='Escape') exitPlacement('Placement cancelled.');
  const dir={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0],w:[0,-1],s:[0,1],a:[-1,0],d:[1,0]}[e.key];
  if(dir){ e.preventDefault(); moveAvatar(dir[0],dir[1]); }
});
// pan/zoom
vp.addEventListener('mousedown',e=>{ if(e.button!==0) return; S.cam.drag=true; S.cam.lastX=e.clientX; S.cam.lastY=e.clientY; vp.classList.add('dragging'); });
window.addEventListener('mouseup',()=>{ S.cam.drag=false; vp.classList.remove('dragging'); });
window.addEventListener('mousemove',e=>{ if(S.cam.drag){ const dx=e.clientX-S.cam.lastX, dy=e.clientY-S.cam.lastY; S.cam.x -= dx/S.cam.z; S.cam.y -= dy/S.cam.z; S.cam.lastX=e.clientX; S.cam.lastY=e.clientY; applyCam(); }});
vp.addEventListener('wheel',e=>{ e.preventDefault(); const dir=Math.sign(e.deltaY); S.cam.z=clamp(S.cam.z*(dir>0?0.9:1.1),0.6,2.5); applyCam(); },{passive:false});

// hover tile info
vp.addEventListener('mousemove',e=>{
  if(S.cam.drag) return;
  const {wx,wy}=screenToWorld(e.clientX,e.clientY); const pos=worldToTile(wx,wy); if(!pos) return;
  const cell=S.tiles[pos.ty][pos.tx];
  const base = `Tile: ${cell.terrain} @ ${pos.tx},${pos.ty}`;
  const resTxt = cell.res? ` ‚Ä¢ Resource: ${cell.res.k} (${cell.res.left})` : '';
  const bTxt = cell.b? ` ‚Ä¢ Building: ${BUILD.find(b=>b.k===cell.b).name}` : '';
  $('#tileInfo').textContent = base + resTxt + bTxt;
});

function placeAt(k,x,y){
  const cell=S.tiles[y][x]; if(cell.b){ toast("Tile occupied"); return; }
  if(cell.terrain==='water'){ toast("Cannot build on water"); return; }
  const b=BUILD.find(q=>q.k===k);
  if(b.unique && S.b[k]){ toast("Only one allowed"); return; }
  const cost = dynCost(k);
  for(const [rk,rv] of Object.entries(cost)){ if((S.res[rk]||0) < rv){ toast("Not enough "+rk); return; } }
  for(const [rk,rv] of Object.entries(cost)){ S.res[rk]-=rv; }
  cell.res=null; cell.b=k; S.b[k]++; if(b.house){ let add=b.house; if(S.mods.cottageBonus && k==='cottage') add += S.mods.cottageBonus; S.res.housing += add; }
  // Track terrain placement bonuses
  if(k==='woodhut' || k==='lumbermill'){
    S.terrain.woodTotal++;
    if(cell.terrain==='forest') S.terrain.woodOnForest++;
  }
  if(k==='quarry'){
    S.terrain.quarryTotal++;
    if(cell.terrain==='hill') S.terrain.quarryOnHill++;
  }
  buildBuildList(); redrawTiles(); updateBuildButtons(); updateResAndMeta(); updateActionButtons();
  exitPlacement("Placed "+b.name+".");
  log("Built "+b.name+" @ "+x+","+y);
  // Quests: building the Longhouse
  if(k==='chief') updateQuests();
}

function upgradeWoodhut(x,y){
  const cell=S.tiles[y][x];
  const cost=dynCost('lumbermill');
  for(const [rk,rv] of Object.entries(cost)){ if((S.res[rk]||0)<rv){ toast('Not enough '+rk); return; } }
  for(const [rk,rv] of Object.entries(cost)){ S.res[rk]-=rv; }
  cell.b='lumbermill';
  S.b.woodhut--; S.b.lumbermill++;
  redrawTiles(); updateBuildButtons(); updateResAndMeta();
  $('#planner').textContent='Upgraded to Lumber Mill.';
}

// minimap
const mini=$('#miniCanvas'); const mctx=mini.getContext('2d'); const miniRect=$('#miniView');
function drawMinimap(){
  const cw=mini.width, ch=mini.height;
  mctx.fillStyle='#0b1130'; mctx.fillRect(0,0,cw,ch);
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      const c=S.tiles[y][x];
      if(!c.b){
        const terr=TERRAIN.find(t=>t.k===c.terrain);
        mctx.fillStyle=terr?terr.color:'#16224a';
      } else {
        const b=BUILD.find(t=>t.k===c.b);
        const map={chief:'#6d5b3a', woodhut:'#3a6b5a', farm:'#5f7c3a', cottage:'#6b5a3a', quarry:'#555f7a', bakery:'#a3764a', inn:'#7a5ca6', claypit:'#7a5a4a', loom:'#8a8ab2', flaxfield:'#507d6b', mine:'#59606f', workshop:'#9c8b6b', shrine:'#a0a8d0', school:'#9fb7e6', market:'#d3a85a'};
        mctx.fillStyle=map[b.k]||'#8aa';
      }
      const mx=Math.floor(x*cw/WORLD_W), my=Math.floor(y*ch/WORLD_H);
      mctx.fillRect(mx,my,Math.ceil(cw/WORLD_W),Math.ceil(ch/WORLD_H));
    }
  }
}
function updateMiniViewRect(){
  const cw=mini.clientWidth, ch=mini.clientHeight; const {cx,cy}=camOffset();
  const vw = vp.clientWidth / (WORLD_W*CELL) / S.cam.z * cw;
  const vh = vp.clientHeight / (WORLD_H*CELL) / S.cam.z * ch;
  const vx = cx / (WORLD_W*CELL) * cw;
  const vy = cy / (WORLD_H*CELL) * ch;
  miniRect.style.left = vx+'px'; miniRect.style.top = vy+'px';
  miniRect.style.width = vw+'px'; miniRect.style.height = vh+'px';
}
mini.parentElement.addEventListener('click',e=>{
  const r=mini.getBoundingClientRect();
  const x=(e.clientX-r.left)/r.width, y=(e.clientY-r.top)/r.height;
  S.cam.x = x*(WORLD_W*CELL) - vp.clientWidth/(2*S.cam.z);
  S.cam.y = y*(WORLD_H*CELL) - vp.clientHeight/(2*S.cam.z);
  applyCam();
});

// ===== gameplay
function updateResAndMeta(){
  RES.forEach(k=>{
    const v=S.res[k]||0;
    const disp = k==='pop' ? v.toFixed(1) : Math.floor(v);
    $('#r_'+k).textContent=disp;
    if(k==='pop'){
      $('#pill_pop').title = `${v.toFixed(1)} / ${Math.floor(S.res.housing||0)} housing`;
    }
  });
  $('#tier').textContent=TIERS[S.tier].name;
  const nxt=TIERS[S.tier+1];
  if(nxt){
    const parts=Object.entries(nxt.need).map(([k,v])=>`${Math.floor(S.res[k]||0)}/${v} ${k}`);
    $('#tierNext').textContent='‚Üí '+nxt.name+': '+parts.join(', ');
  } else $('#tierNext').textContent='';
  $('#day').textContent=S.day;
  $('#season').textContent=SEASONS[S.season].name;
  const h=Math.floor(S.secs/60)%24, m=Math.floor(S.secs%60);
  $('#clock').textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
  $('#happy').textContent=Math.round(S.happy)+'%';
  $('#techActive').textContent = 'Known: '+[...S.techs].join(', ');
  $('#knCur').textContent = Math.floor(S.res.knowledge||0);
  // Hero badge
  const hb=$('#heroBadge'); const ht=$('#heroTime');
  if(S.heroBuffTimer && S.heroBuffTimer>0){
    hb.style.display='inline-block';
    const m=Math.floor(S.heroBuffTimer), s=Math.floor((S.heroBuffTimer-m)*60);
    ht.textContent = String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  } else { hb.style.display='none'; }
  // Victory pill
  const vp=$('#victoryPill'); const vt=$('#victoryText');
  if(S.won){ vp.style.display='inline-block'; vt.textContent=S.won; } else { vp.style.display='none'; }
  // Policies panel
  const pol=$('#policies'); if(pol){
    const pct=v=>((v-1)*100).toFixed(1)+(v>=1?'%':'%');
    pol.innerHTML = [
      `Production: <b>${pct(S.policy.prod||1)}</b>`,
      `Knowledge: <b>${pct(S.policy.knowledge||1)}</b>`,
      `Gold: <b>${pct(S.policy.gold||1)}</b>`,
      `Culture: <b>${pct(S.policy.culture||1)}</b>`,
      `Faith: <b>${pct(S.policy.faith||1)}</b>`
    ].join('<br>');
  }
  const gsum=$('#govPolSummary'); if(gsum){
    const polPct = (k)=>(((S.policy[k]||1)-1)*100).toFixed(0)+'%';
    gsum.textContent = `Gov: ${S.gov||'None'} ‚Äî Policy: Prod ${polPct('prod')}, Kn ${polPct('knowledge')}, Gold ${polPct('gold')}, Cult ${polPct('culture')}, Faith ${polPct('faith')}`;
  }
}
function updateBuildButtons(){
  BUILD.forEach(b=>{
    const cnt=document.getElementById('cnt_'+b.k); if(cnt) cnt.textContent=S.b[b.k];
    const btn=document.getElementById('build_'+b.k); if(!btn) return;
    const ok=Object.entries(dynCost(b.k)).every(([k,v])=>(S.res[k]||0)>=v) && (!b.need || S.techs.has(b.need)) && (!b.unique || !S.b[b.k]);
    btn.disabled=!ok;
  });
}
function updateActionButtons(){
  const cell=S.tiles[S.avatar.y][S.avatar.x];
  const res=cell.res?cell.res.k:null;
  const map={tree:'#gWood',berry:'#gFood',stone:'#gStone',clay:'#gClay',flax:'#gFlax',crystal:'#gMana'};
  for(const [k,sel] of Object.entries(map)){
    const b=$(sel); const cd=b.dataset.cd==='1';
    b.disabled = cd || res!==k;
  }
  const rbtn=$('#recruit');
  const atChief=cell.b==='chief';
  const can = atChief && S.res.food>=30 && (S.res.housing||0)>S.res.pop;
  rbtn.disabled = rbtn.dataset.cd==='1' || !can;
  const sb=$('#scout'); if(sb){ sb.disabled = sb.dataset.cd==='1' || (S.longhouseLvl||0)<2; }
  const hb=$('#hero'); if(hb){ hb.disabled = hb.dataset.cd==='1' || (S.longhouseLvl||0)<3 || (S.heroBuffTimer||0)>0 || (S.res.gold||0)<50 || (S.res.food||0)<20; }
}

function upgradeLonghouse(){
  const lvl=S.longhouseLvl;
  const costs=[
    null,
    {wood:60,stone:50,gold:30}, // ‚ûú Council Hall
    {wood:80,stone:80,gold:60,tools:20}, // ‚ûú War Room
    {wood:120,stone:120,gold:120,linen:30}, // ‚ûú Great Hall
  ];
  if(lvl>=3) return;
  const next=costs[lvl+1];
  for(const [k,v] of Object.entries(next)){ if((S.res[k]||0)<v){ toast('Not enough '+k); return; } }
  for(const [k,v] of Object.entries(next)){ S.res[k]-=v; }
  S.longhouseLvl++;
  // small immediate benefit per upgrade
  if(S.longhouseLvl===1){ log('The Council Hall convenes. Knowledge will flow more often.'); }
  if(S.longhouseLvl===2){ log('War Room established. Scouts and guards respond faster to threats.'); }
  if(S.longhouseLvl===3){ log('Great Hall rises. Heroes and visitors bring culture and tales.'); }
  updateResAndMeta(); updateBuildButtons();
  // refresh planner UI
  const cell=S.tiles[S.avatar.y][S.avatar.x]; if(cell){ $('#planner').innerHTML+=''; }
}

function delveDungeon(x,y){
  if(!(S.b.guild||0)){ toast('Need an Adventurers Guild'); return; }
  if(!(S.avatar.x===x && S.avatar.y===y)){ toast('Move onto the dungeon to delve'); return; }
  const cell=S.tiles[y][x]; if(!cell.res || cell.res.k!=='dungeon'){ toast('No dungeon here'); return; }
  // simple outcome roll
  const r=Math.random();
  if(r<0.6){ S.res.gold += 30; log('Your adventurers return with spoils (+30 gold).'); }
  else if(r<0.85){ S.res.iron += 4; log('Ore veins discovered (+4 iron).'); }
  else { S.res.pop = Math.max(0, S.res.pop-1); log('A tragic loss in the depths (-1 pop).'); }
  cell.res=null; redrawTiles(); updateResAndMeta(); updateBuildButtons();
}

// --- Tutorial quests (simple intro tasks)
function renderQuests(){
  const qel=$('#quests'); if(!qel) return;
  qel.innerHTML='';
  S.quests.forEach(q=>{
    const row=document.createElement('div'); row.className='small';
    const mark = q.done ? '‚úÖ' : '‚¨ú';
    row.textContent = mark+ ' ' + q.text;
    qel.appendChild(row);
  });
}
function updateQuests(){
  let changed=false;
  S.quests.forEach(q=>{
    if(q.done) return;
    if(q.id==='q_move_gather' && S.didFirstGather){ q.done=true; changed=true; S.res.wood+=10; log('Quest complete: Gather once (+10 wood).'); }
    if(q.id==='q_build_chief' && (S.b.chief||0)>0){ q.done=true; changed=true; S.res.knowledge+=1; log("Quest complete: Longhouse built (+1 üìú)."); }
  });
  if(changed){ updateResAndMeta(); renderQuests(); }
}
function prodMult(b){
  let m = S.mods.allMult;
  if(b.k==='woodhut' || b.k==='lumbermill'){
    m*=S.mods.woodhutMult;
    if(S.terrain.woodTotal>0){ m *= (1 + 0.1 * (S.terrain.woodOnForest / S.terrain.woodTotal)); }
  }
  if(b.k==='quarry'){
    if(S.terrain.quarryTotal>0){ m *= (1 + 0.1 * (S.terrain.quarryOnHill / S.terrain.quarryTotal)); }
  }
  // adjacency synergies: farms and wheat fields
  if(b.k==='farm') m *= avgAdjMult('farm','wheatfield',0.15);
  if(b.k==='wheatfield') m *= avgAdjMult('wheatfield','farm',0.10);
  // herd synergy: ranch output scales with nearby animals
  if(b.k==='ranch') m *= (1 + Math.min(0.5, 0.05 * avgAnimalsNear('ranch',3)));
  if((S.heroBuffTimer||0)>0) m*=1.25;
  if((S.enchantBuffTimer||0)>0) m*=1.10;
  return m;
}

function avgAdjMult(type, neighbor, perAdj){
  let count=0, total=0;
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      if(S.tiles[y][x].b===type){ count++; total += countAdj(x,y,neighbor); }
    }
  }
  if(count===0) return 1;
  const avg = total/count;
  return 1 + perAdj*avg;
}
function countAdj(x,y,type){
  const dirs=[[1,0],[-1,0],[0,1],[0,-1]]; let c=0;
  for(const [dx,dy] of dirs){ const nx=x+dx, ny=y+dy; if(nx>=0&&ny>=0&&nx<WORLD_W&&ny<WORLD_H){ if(S.tiles[ny][nx].b===type) c++; } }
  return c;
}
function avgAnimalsNear(type, r){
  let count=0, total=0;
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      if(S.tiles[y][x].b===type){
        count++;
        let n=0;
        for(const c of critters){ if(c.type==='animal' && Math.abs(c.x-x)+Math.abs(c.y-y) <= r) n++; }
        total += n;
      }
    }
  }
  return count? (total/count) : 0;
}

// --- Simple delivery visuals: send a courier to the Longhouse
function findChiefPos(){
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      if(S.tiles[y][x].b==='chief') return {x,y};
    }
  }
  return null;
}
function spawnCourier(sx,sy,tx,ty,emoji='üß∫'){
  const el=document.createElement('div'); el.className='courier'; el.textContent=emoji;
  el.style.transform = `translate(${sx*CELL}px, ${sy*CELL}px)`;
  mapEl.appendChild(el);
  requestAnimationFrame(()=>{
    el.style.transform = `translate(${tx*CELL}px, ${ty*CELL}px)`;
  });
  setTimeout(()=>{ el.remove(); }, 2200);
}
function spawnDeliveries(){
  const chief=findChiefPos(); if(!chief) return;
  // collect producer positions (sample a few to avoid overdraw)
  const picks=[];
  for(let y=0;y<WORLD_H;y++){
    for(let x=0;x<WORLD_W;x++){
      const k=S.tiles[y][x].b; if(!k) continue;
      const b=BUILD.find(z=>z.k===k); if(!b||!b.prod) continue;
      if(Math.random()<0.04) picks.push({x,y});
    }
  }
  picks.slice(0,3).forEach(p=>spawnCourier(p.x,p.y,chief.x,chief.y));
}
function spawnPing(x,y){
  const el=document.createElement('div'); el.className='ping'; el.style.left=(x*CELL)+'px'; el.style.top=(y*CELL)+'px'; mapEl.appendChild(el); setTimeout(()=>el.remove(),1400);
}
function spawnGlow(x,y){
  const el=document.createElement('div'); el.className='glow'; el.style.left=(x*CELL)+'px'; el.style.top=(y*CELL)+'px'; mapEl.appendChild(el); setTimeout(()=>el.remove(),3000);
}
function produce(dtMinutes){
  const dt = dtMinutes/60;
  BUILD.forEach(b=>{
    const n=S.b[b.k]; if(!n) return;
    const skip={};
    // consumption
    if(b.use){
      if(b.use.food){
        let need=b.use.food*n*dt;
        if(b.k==='bakery') need*= (S.mods.bakeryFoodUse||1);
        const used=Math.min(need,S.res.food);
        S.res.food-=used;
        const r=need?used/need:1;
        if(b.prod && b.prod.gold){
          S.res.gold += b.prod.gold*n*r*dt*(S.mods.bakeryGold||1);
          skip.gold=true;
        }
      }
      if(b.use.iron){
        const need=b.use.iron*n*dt;
        const used=Math.min(need,S.res.iron);
        S.res.iron-=used;
        const r=need?used/need:1;
        if(b.prod && b.prod.tools){
          let v=b.prod.tools*n*r*dt*prodMult(b);
          if(S.mods.toolBonus) v*=1.2;
          v*= (S.mods.toolNerf||1);
          S.res.tools += v;
          skip.tools=true;
        }
      }
      if(b.use.wood){
        const need=b.use.wood*n*dt;
        const used=Math.min(need,S.res.wood);
        S.res.wood-=used;
      }
      if(b.use.flax){
        const need=b.use.flax*n*dt;
        const used=Math.min(need,S.res.flax);
        S.res.flax-=used;
        const r=need?used/need:1;
        if(b.prod && b.prod.linen){
          S.res.linen += b.prod.linen*n*r*dt*prodMult(b);
          skip.linen=true;
        }
      }
      if(b.use.tools){
        const need=b.use.tools*n*dt;
        const used=Math.min(need,S.res.tools||0);
        S.res.tools=(S.res.tools||0)-used;
      }
      if(b.use.mana){
        const need=b.use.mana*n*dt;
        const used=Math.min(need,S.res.mana||0);
        S.res.mana=(S.res.mana||0)-used;
        if(b.k==='enchanter' && used>0){
          S.enchantBuffTimer = Math.min((S.enchantBuffTimer||0)+2*used, 20);
        }
      }
      if(b.use.meat){
        const need=b.use.meat*n*dt;
        const used=Math.min(need,S.res.meat||0);
        S.res.meat=(S.res.meat||0)-used;
        const r=need?used/need:1;
        if(b.prod && b.prod.food){
          S.res.food += b.prod.food*n*r*dt*prodMult(b);
          skip.food=true;
        }
      }
    }
    // production
    if(b.prod){
      for(const k in b.prod){
        if(skip[k]) continue; // handled in consumption
        let v=b.prod[k]*n*prodMult(b);
        if(b.k==='farm' && k==='food') v*=SEASONS[S.season].farm;
        if(b.k==='inn' && k==='culture') v*=S.mods.innCulture;
        if(b.k==='shrine' && k==='faith') v*=(S.mods.faithBonus||1);
        // apply policy multipliers
        if(k==='gold') v*= (S.policy.gold||1);
        if(k==='knowledge') v*= (S.policy.knowledge||1);
        if(k==='culture') v*= (S.policy.culture||1);
        if(k==='faith') v*= (S.policy.faith||1);
        S.res[k]+=v*dt;
      }
    }
    if(b.mood) S.happy += b.mood*dt;
  });

  // Market passive
  const mkt=S.b.market||0; if(mkt>0) S.res.gold += (0.02*mkt)*(S.res.pop*0.2 + S.res.culture*0.05)*dt * (S.gov==='League'?1.15:1) * (S.policy.gold||1);
  // sea trade multiplier
  if(S.mods.seaGold && S.mods.seaGold!==1){ S.res.gold *= S.mods.seaGold; }

  // Pop growth & food
  const spare=(S.res.housing||0)-(S.res.pop||0);
// spare is defined just above this block
const growing = spare > 0 && S.res.food > 20;

if (growing) {
  // keep main's happiness multiplier
  const mult = Math.max(1, (S.happy - 100) / 100) * (S.mods.popMult||1);
  S.res.pop = Math.min(S.res.pop + 0.01 * mult * dt, S.res.housing);
}

const now = Math.floor(S.res.pop || 0);

// keep codex's grow-state toggle + redraw
if (growing !== S.growing) { S.growing = growing; redrawTiles(); }

// keep main's per-villager arrival log (avoids duplicate/ambiguous messages)
while (lastPop < now) {
  lastPop++;
  log(`New villager arrived (population: ${lastPop}).`);
}

  const eat=Math.min(S.res.food, (S.res.pop*0.02)*dt); S.res.food -= eat;
  if(S.res.food<5) S.happy -= 0.05*dt; else S.happy += 0.02*dt;
  S.happy = clamp(S.happy, 50, 130);

  // Time & season & tier
  S.secs += dtMinutes;
  if(S.secs>=24*60){ S.secs-=24*60; S.day++; if((S.day-1)%8===0){ S.season=(S.season+1)%SEASONS.length; log("Season is now "+SEASONS[S.season].name+"."); } }
  const nxt=TIERS[S.tier+1]; if(nxt){ const ok=Object.entries(nxt.need).every(([k,v])=>(S.res[k]||0)>=v); if(ok){ S.tier++; log("Advanced to "+TIERS[S.tier].name+"!"); } }

  // --- NEW: Knowledge chance from Chief‚Äôs Longhouse (every 10 minutes)
  S.timers.chief += dtMinutes;
  const chiefCount = 0; // overridden by scaled knowledge system below
  while(S.timers.chief >= 10 && chiefCount>0){
    const p = Math.min(0.6, 0.15*chiefCount + 0.01*(S.res.pop||0)); // 10-min cycle chance
    if(Math.random() < p){ S.res.knowledge += 1; log("The elders share lore at the Chief‚Äôs Longhouse (+1 üìú)."); }
    S.timers.chief -= 10;
  }
  // Council events every ~20 minutes if upgraded
  if((S.longhouseLvl||0) >= 1 && !S.eventOpen){ S.eventTimer += dtMinutes; if(S.eventTimer>=20){ S.eventTimer=0; openRandomEvent(); } }
  
  // Scaled knowledge (every 10 minutes)
  while(S.timers.chief >= 10 && (S.b.chief||0)>0){
    const lvl=(S.longhouseLvl||0);
    const perPop = 0.01 + 0.005*lvl; // per 10 min per pop
    let gainAmt = Math.max(1, Math.floor((S.res.pop||0) * perPop));
    if(S.gov==='Republic') gainAmt = Math.ceil(gainAmt*1.1);
    gainAmt = Math.max(1, Math.floor(gainAmt * (S.mods.knowledgeBonus||1) * (S.policy.knowledge||1)));
    S.res.knowledge += gainAmt;
    log(`Council shares lore (+${gainAmt} üìú; hall lvl ${lvl}).`);
    S.timers.chief -= 10;
  }

  // --- NEW: Quarry rare finds (every 30 minutes per quarry)
  S.timers.quarry += dtMinutes;
  const qCount = S.b.quarry||0;
  while(S.timers.quarry >= 30 && qCount>0){
    for(let i=0;i<qCount;i++){
      if(Math.random()<0.07){ S.res.iron += 1; log("Your quarry unearthed rich iron ore (+1 ‚õìÔ∏è)."); }
      if(Math.random()<0.03){ S.res.gold += 1; log("A glimmer in the rock‚Ä¶ gold! (+1 üí∞)."); }
    }
    S.timers.quarry -= 30;
  }
  // Delivery visuals every ~5 in-game minutes
  S.delivery += dtMinutes;
  if(S.delivery >= 5){ S.delivery -= 5; spawnDeliveries(); }
  if((S.heroBuffTimer||0)>0){ S.heroBuffTimer = Math.max(0, S.heroBuffTimer - dtMinutes); }
  if((S.enchantBuffTimer||0)>0){ S.enchantBuffTimer = Math.max(0, S.enchantBuffTimer - dtMinutes); }
  // Hunters: resolve hunts roughly every in-game minute
  S.hunterT = (S.hunterT||0) + dtMinutes;
  while(S.hunterT>=1){ S.hunterT-=1; autoHunt(); }
}

function autoHunt(){
  const lodges=S.b.hunterlodge||0; if(!lodges) return;
  let hunted=0;
  for(let i=critters.length-1;i>=0 && hunted<lodges;i--){
    const c=critters[i]; if(c.type!=='animal') continue;
    critters.splice(i,1); if(c.el) c.el.remove();
    let meat=1, hide=1; if(S.b.tanner) { meat=Math.ceil(meat*1.25); hide=Math.ceil(hide*1.25); }
    S.res.meat=(S.res.meat||0)+meat; S.res.hide=(S.res.hide||0)+hide;
    const chief=findChiefPos(); if(chief) spawnCourier(c.x,c.y,chief.x,chief.y,'üß∫');
    log(`Hunter returns with ${meat} üçñ and ${hide} ü¶å.`);
    hunted++;
  }
  updateResAndMeta();
}

// Tech Tree UI
const TECH_DATA = TECH;
$('#btnTechTree').onclick=()=>{ openTechTree(); };
$('#techClose').onclick=()=>{ closeTechTree(); };
function openTechTree(){ $('#techModal').style.display='flex'; renderTechTree(); updateResAndMeta(); }
function closeTechTree(){ $('#techModal').style.display='none'; $('#techCanvas').innerHTML=''; $('#techEdges').innerHTML=''; }

// ===== Council Events
function openRandomEvent(){
  const ev = genEvent();
  S.eventOpen=true;
  $('#eventTitle').innerHTML = `<b>${ev.title}</b>`;
  $('#eventText').textContent = ev.text;
  const box=$('#eventChoices'); box.innerHTML='';
  ev.choices.forEach((ch,i)=>{
    const btn=document.createElement('button'); btn.className='btn'; btn.style='display:block; margin:6px 0';
    const costTxt = Object.keys(ch.cost||{}).length? ' ‚Äî Cost: '+Object.entries(ch.cost).map(([k,v])=>`${v} ${k}`).join(', ') : '';
    const rewTxt = Object.keys(ch.reward||{}).length? ' ‚Äî Gain: '+Object.entries(ch.reward).map(([k,v])=>`${v} ${k}`).join(', ') : '';
    const tail = ch.mystery? ' ‚Äî Uncertain' : '';
    btn.textContent = ch.label + costTxt + rewTxt + tail;
    btn.onclick=()=>applyEventChoice(ch);
    box.appendChild(btn);
  });
  $('#eventModal').style.display='flex';
}
function closeEvent(){ $('#eventModal').style.display='none'; S.eventOpen=false; }
$('#eventClose').onclick=()=>{ closeEvent(); };

function haveResources(cost){ return Object.entries(cost||{}).every(([k,v])=>(S.res[k]||0)>=v); }
function applyCost(cost){ Object.entries(cost||{}).forEach(([k,v])=>{ S.res[k]-=v; }); }
function applyReward(rew){ Object.entries(rew||{}).forEach(([k,v])=>{ S.res[k]=(S.res[k]||0)+v; }); }

function applyEventChoice(ch){
  if(!haveResources(ch.cost||{})){ toast('Not enough resources'); return; }
  applyCost(ch.cost||{});
  // hidden penalty with small chance on mystery
  if(ch.hidden){ applyCost(ch.hidden); log('Unexpected complications increased the cost.'); }
  applyReward(ch.reward||{});
  if(ch.policy){ for(const [k,v] of Object.entries(ch.policy)){ S.policy[k] = (S.policy[k]||1) * (1+v); } }
  if(ch.log) log(ch.log);
  updateResAndMeta(); closeEvent();
}

function genEvent(){
  const base=[genBardEvent, genCouncilDisputeEvent, genTraderEvent, genShrineOmenEvent];
  const gov=S.gov||'';
  const govExtra=[];
  if(gov==='Military') govExtra.push(genMilitaryRallyEvent);
  if(gov==='League') govExtra.push(genLeagueContractEvent);
  if(gov==='Theocracy') govExtra.push(genPilgrimageEvent);
  if(gov==='Republic') govExtra.push(genAssemblyEvent);
  if(gov==='Monarchy') govExtra.push(genTournamentEvent);
  if(gov==='Gerontocracy') govExtra.push(genElderWisdomEvent);
  if(gov==='Shamanism') govExtra.push(genTotemEvent);
  if(gov==='Meritocracy') govExtra.push(genExaminationEvent);
  if(gov==='Magocracy') govExtra.push(genMageDebateEvent);
  const pool = base.concat(govExtra.length? govExtra:[]);
  const f=pool[Math.floor(Math.random()*pool.length)];
  return f();
}
function genBardEvent(){
  const lvl=S.longhouseLvl||0;
  const base={title:'A Wandering Bard', text:'A bard seeks patronage at your hall.', choices:[]};
  base.choices.push({label:'Host a performance', cost:{food:10}, reward:{culture:8+2*lvl}, policy:{culture:0.01}, log:'Songs fill the night. Culture rises.'});
  base.choices.push({label:'Commission an epic', cost:{gold:20}, reward:{culture:20+5*lvl}, mystery:true, hidden: Math.random()<0.5? {gold:10}: null, policy:{culture:0.02}, log:'The epic stirs hearts across the hamlet.'});
  base.choices.push({label:'Decline politely', cost:{}, reward:{}, log:'The bard moves on.'});
  return base;
}
function genCouncilDisputeEvent(){
  const lvl=S.longhouseLvl||0;
  const base={title:'Village Dispute', text:'Two families seek council over grazing rights.', choices:[]};
  base.choices.push({label:'Compensate both sides', cost:{gold:15}, reward:{happy:2}, policy:{prod:0.005}, log:'Fairness improves morale.'});
  base.choices.push({label:'Side with the herders', cost:{}, reward:{food:10}, mystery:true, hidden: {culture: -3}, policy:{gold:0.005}, log:'Food stocks improve, but some feel slighted.'});
  base.choices.push({label:'Delay and study law', cost:{knowledge:Math.max(1,lvl)}, reward:{knowledge:2+lvl}, policy:{knowledge:0.01}, log:'You learn from precedent.'});
  return base;
}
function genTraderEvent(){
  const base={title:'Traveling Trader', text:'A trader offers odd wares and tools.', choices:[]};
  base.choices.push({label:'Buy tools', cost:{gold:25}, reward:{tools:10}, policy:{prod:0.005}, log:'Your workshops hum.'});
  base.choices.push({label:'Trade linens', cost:{linen:10}, reward:{gold:20}, policy:{gold:0.01}, log:'A tidy profit.'});
  base.choices.push({label:'Mystery crate', cost:{gold:15}, reward: Math.random()<0.5? {mana:1}:{iron:3}, mystery:true, hidden: Math.random()<0.3? {gold:5}: null, policy:{prod:0.003}, log:'You take a chance on the unknown.'});
  return base;
}
function genShrineOmenEvent(){
  const base={title:'Strange Omen', text:'Travelers report lights over the old stones.', choices:[]};
  base.choices.push({label:'Send a prayer', cost:{faith:2}, reward:{happy:2}, policy:{faith:0.01}, log:'Hearts are eased.'});
  base.choices.push({label:'Investigate', cost:{tools:5}, reward:{knowledge:3}, mystery:true, hidden: Math.random()<0.3? {tools:3}: null, policy:{knowledge:0.008}, log:'Findings spark debate among elders.'});
  base.choices.push({label:'Ignore it', cost:{}, reward:{}, log:'Life goes on.'});
  return base;
}
// Government-aligned events
function genMilitaryRallyEvent(){
  const base={title:'Military Rally', text:'Commanders plan drills to keep order.', choices:[]};
  base.choices.push({label:'Fund the drills', cost:{gold:25,food:10}, reward:{}, policy:{prod:0.006}, log:'Discipline improves labor efficiency.'});
  base.choices.push({label:'Recruit more guards', cost:{food:20}, reward:{}, policy:{gold:0.004}, log:'Security boosts trade confidence.'});
  base.choices.push({label:'Stand down', cost:{}, reward:{}, log:'You conserve resources.'});
  return base;
}
function genLeagueContractEvent(){
  const base={title:'Lucrative Contract', text:'A distant city seeks long-term goods.', choices:[]};
  base.choices.push({label:'Sign the deal', cost:{linen:10}, reward:{gold:35}, policy:{gold:0.012}, log:'Trade flourishes under new terms.'});
  base.choices.push({label:'Invest in caravans', cost:{gold:30}, reward:{}, policy:{prod:0.005, gold:0.006}, log:'Logistics strengthen your economy.'});
  base.choices.push({label:'Decline', cost:{}, reward:{}, log:'You pass for now.'});
  return base;
}
function genPilgrimageEvent(){
  const base={title:'Great Pilgrimage', text:'Faithful pilgrims request accommodations.', choices:[]};
  base.choices.push({label:'Host pilgrims', cost:{food:20}, reward:{faith:20}, policy:{faith:0.015}, log:'Your shrine gains renown.'});
  base.choices.push({label:'Sell relics', cost:{faith:10}, reward:{gold:25}, policy:{gold:0.006}, log:'Offerings replenish coffers.'});
  base.choices.push({label:'Refuse crowds', cost:{}, reward:{}, log:'Caution prevails.'});
  return base;
}
function genAssemblyEvent(){
  const base={title:'Open Assembly', text:'Citizens debate public works.', choices:[]};
  base.choices.push({label:'Fund schools', cost:{gold:25}, reward:{knowledge:6}, policy:{knowledge:0.015}, log:'Education thrives.'});
  base.choices.push({label:'Build roads', cost:{stone:30}, reward:{}, policy:{prod:0.007}, log:'Roads boost productivity.'});
  base.choices.push({label:'Table it', cost:{}, reward:{}, log:'No action taken.'});
  return base;
}
function genTournamentEvent(){
  const base={title:'Royal Tournament', text:'Nobles sponsor games and feasts.', choices:[]};
  base.choices.push({label:'Grand feast', cost:{food:30, gold:20}, reward:{culture:20}, policy:{culture:0.01}, log:'Festivities stir the realm.'});
  base.choices.push({label:'Knightly games', cost:{tools:10}, reward:{}, policy:{prod:0.005}, log:'Competition sharpens craft.'});
  base.choices.push({label:'Modest ceremony', cost:{gold:10}, reward:{}, log:'A measured celebration.'});
  return base;
}
function genElderWisdomEvent(){
  const base={title:'Elders‚Äô Counsel', text:'Seasoned voices propose reforms.', choices:[]};
  base.choices.push({label:'Codify traditions', cost:{knowledge:8}, reward:{}, policy:{knowledge:0.012}, log:'Lore accumulates steadily.'});
  base.choices.push({label:'Apprentice program', cost:{tools:8}, reward:{}, policy:{prod:0.006}, log:'Craft is passed carefully.'});
  base.choices.push({label:'Adjourn', cost:{}, reward:{}, log:'Patience is a virtue.'});
  return base;
}
function genTotemEvent(){
  const base={title:'Totem Rite', text:'Shamans read the wind and bone.', choices:[]};
  base.choices.push({label:'Anoint the hunt', cost:{food:12}, reward:{hide:6}, policy:{faith:0.01}, log:'Spirits favor the chase.'});
  base.choices.push({label:'Ward the hamlet', cost:{faith:6}, reward:{}, policy:{prod:0.004}, log:'Neighbors sleep easier.'});
  base.choices.push({label:'Let omens pass', cost:{}, reward:{}, log:'Perhaps next moon.'});
  return base;
}
function genExaminationEvent(){
  const base={title:'Civil Examinations', text:'Appointments by merit over birth.', choices:[]};
  base.choices.push({label:'Fund tutors', cost:{gold:25}, reward:{knowledge:8}, policy:{prod:0.004, knowledge:0.01}, log:'Standards rise.'});
  base.choices.push({label:'Tool stipends', cost:{tools:8}, reward:{}, policy:{prod:0.006}, log:'Workshops benefit.'});
  base.choices.push({label:'Cancel exams', cost:{}, reward:{}, log:'You defer for now.'});
  return base;
}
function genMageDebateEvent(){
  const base={title:'Arcane Debate', text:'Magi argue method and ethics.', choices:[]};
  base.choices.push({label:'Fund experiments', cost:{mana:2}, reward:{knowledge:6}, policy:{knowledge:0.012}, log:'Breakthroughs follow.'});
  base.choices.push({label:'Standardize practice', cost:{knowledge:6}, reward:{}, policy:{prod:0.005}, log:'Safety improves output.'});
  base.choices.push({label:'Restrict studies', cost:{}, reward:{}, policy:{gold:0.004}, log:'Resources shift to commerce.'});
  return base;
}
function nodeStatus(id){
  const node = TECH_DATA.find(t=>t.id===id);
  const owned = S.techs.has(node.name);
  if(owned) return 'owned';
  // lock other government types if one already chosen
  if(id.startsWith('gov_') && S.gov && !owned) return 'locked';
  let ok = node.prereq.every(pid=> S.techs.has(TECH_DATA.find(t=>t.id===pid).name));
  if(ok && node.reqRes){ ok = Object.entries(node.reqRes).every(([k,v])=> (S.res[k]||0)>=v); }
  return ok ? 'available' : 'locked';
}
function applyTechEffects(name){
  switch(name){
    case 'Masonry': S.mods.mineDiscount=0.15; S.mods.stoneForage=1.1; log("Masonry improves stonework (+10% stone scavenging, cheaper mines)."); break;
    case 'Spirituality': S.happy+=5; log("Spirituality lifts hearts (+5 happiness)."); break;
    case 'Learning': S.mods.woodhutMult=1.10; log("Learning boosts forestry (+10% woodcutters)."); break;
    case 'Forestry': S.mods.woodhutMult*=1.25; log("Forestry advances logging (+25% woodcutters)."); break;
    case 'Crafting': S.mods.toolBonus=true; S.mods.allMult*=1.10; log("Crafting refines output (+10% production, +20% tools)."); break;
    case 'Trade Guilds': S.mods.innCulture=1.20; log("Trade Guilds make taverns livelier (+20% culture from Inns)."); break;
    case 'Stone Roads': S.mods.allMult*=1.10; log("Stone Roads quicken every craft (+10% all production)."); break;
    case 'Brewcraft': S.mods.bakeryGold=1.20; S.mods.bakeryFoodUse=1.10; log("Brewcraft enriches bakeries (+20% gold, +10% grain use)."); break;
    case 'Governing Council': S.mods.cottageBonus=2; S.res.housing += 2*(S.b.cottage||0); log("Council grants better housing (+2 per Cottage)."); break;
    case 'Architecture': S.res.housing += (S.b.cottage||0); log("Architecture improves dwellings (+1 housing per Cottage)."); break;
    case 'Exploration': S.avatar.spd*=1.5; log("Exploration trains swift scouts (+50% avatar speed)."); break;
    case 'Beast Taming': log("Beast Taming allows hides from wildlife."); break;
    case 'Guard Towers': log("Guard Towers can now be raised."); break;
    case 'Dungeoneering': log("Dungeoneering opens the way to clear dungeons."); break;
    case 'Arcana': S.mods.manaProd*=1.10; log("Arcana taps minor mana flows (+10% mana)."); break;
    case 'Wizardry': S.mods.manaProd*=1.20; log("Wizardry schools refine mana (+20% mana)."); break;
    case 'Enchanting': S.mods.toolBonus=true; log("Enchanting empowers tools."); break;
    case 'Runecraft': S.mods.knowledgeBonus*=1.10; log("Runecraft reveals hidden lore (+10% knowledge)."); break;
    case 'Astronomy': S.mods.knowledgeBonus*=1.20; log("Astronomy charts the heavens (+20% knowledge)."); break;
    case 'Grand Council': S.mods.allMult*=1.05; log("Grand Council harmonizes work (+5% all production)."); break;
    case 'Realm Magic': S.mods.manaProd*=1.30; log("Realm Magic surges mana (+30% mana)."); break;
    case 'Dragon Lore': S.mods.hideBonus*=1.50; log("Dragon Lore hardens hides (+50% hides)."); break;
    case 'Sky Fleet': S.mods.allMult*=1.05; log("Sky Fleet inspires productivity (+5% all production)."); break;
    case 'Mystic Order': S.mods.manaProd*=1.20; log("Mystic Order channels mana (+20% mana)."); break;
    case 'Planar Gates': S.mods.knowledgeBonus*=1.30; log("Planar Gates expand minds (+30% knowledge)."); break;
    case 'Eternal Peace': S.happy+=10; log("Eternal Peace soothes hearts (+10 happiness)."); break;
    case 'Divine Right': S.mods.cultureBonus*=1.20; log("Divine Right elevates culture (+20% culture)."); break;
    case 'Cosmic Insight': S.mods.manaProd*=1.20; log("Cosmic Insight floods mana (+20% mana)."); break;
    case 'Chronomancy': S.mods.speedBonus*=1.20; log("Chronomancy bends time (+20% speed)."); break;
    case 'Utopia': S.mods.allMult*=1.20; log("Utopia increases all production (+20% all)."); break;
    case 'Ascension': log("Ascension achieved. You win!"); break;
    case 'Engineering': S.mods.allMult*=1.05; log("Engineering improves works (+5% all)."); break;
    case 'Bridges': S.avatar.spd*=1.2; log("Bridges ease travel (+20% avatar speed)."); break;
    case 'Waterworks': S.mods.allMult*=1.05; log("Waterworks help farms and mills (+5% all)."); break;
    case 'Seafaring': S.mods.bakeryGold=1.25; log("Seafaring expands trade (+25% market/bakery gold)."); break;
    case 'Naval Logistics': S.mods.seaGold*=1.15; log("Naval Logistics multiplies sea trade (+15% market gold)."); break;
    case 'Civics': S.res.housing += (S.b.cottage||0); S.mods.cultureBonus*=1.05; log("Civics strengthen society (+housing, +culture)."); break;
    case 'Public Works': S.mods.costDiscount=0.9; log("Public Works reduces build costs (-10%)."); break;
    case 'Legal Reforms': S.mods.knowledgeBonus*=1.10; log("Legal Reforms improve scholarship (+10% knowledge)."); break;
    case 'Engineering': S.mods.allMult*=1.05; log("Engineering improves works (+5% all)."); break;
    case 'Bridges': S.avatar.spd*=1.2; log("Bridges ease travel (+20% avatar speed)."); break;
    case 'Waterworks': S.mods.allMult*=1.05; log("Waterworks help farms and mills (+5% all)."); break;
    case 'Seafaring': S.mods.bakeryGold=1.25; log("Seafaring expands trade (+25% market/bakery gold)."); break;
    case 'Civics': S.res.housing += (S.b.cottage||0); S.mods.cultureBonus*=1.05; log("Civics strengthen society (+housing, +culture)."); break;
    case 'Monarchy': if(S.gov){ log('A government already rules.'); break;} S.gov='Monarchy'; S.mods.allMult*=1.05; S.happy+=3; log("Government: Monarchy (+5% all, +3 happiness; slower discoveries)."); break;
    case 'Council Republic': if(S.gov){ log('A government already rules.'); break;} S.gov='Republic'; S.mods.knowledgeBonus*=1.15; S.mods.allMult*=1.02; log("Government: Council Republic (+15% knowledge, +2% all; -gold)."); break;
    case 'Theocracy': if(S.gov){ log('A government already rules.'); break;} S.gov='Theocracy'; S.mods.faithBonus= (S.mods.faithBonus||1)*1.3; S.mods.toolNerf=0.9; S.happy+=5; log("Government: Theocracy (+30% faith, +5 happiness; -10% tools)."); break;
    case 'Merchant League': if(S.gov){ log('A government already rules.'); break;} S.gov='League'; S.mods.bakeryGold*=1.35; S.mods.allMult*=1.02; S.happy-=3; log("Government: Merchant League (+35% gold, +2% all; -3 happiness)."); break;
    // Governments (extras)
    case 'Gerontocracy': if(S.gov){ log('A government already rules.'); break;} S.gov='Gerontocracy'; S.mods.knowledgeBonus*=1.10; S.mods.popMult*=0.9; log('Government: Gerontocracy (+10% knowledge, -10% pop growth).'); break;
    case 'Shamanism': if(S.gov){ log('A government already rules.'); break;} S.gov='Shamanism'; S.mods.faithBonus=(S.mods.faithBonus||1)*1.2; S.mods.hideBonus*=1.1; S.mods.knowledgeBonus*=0.95; log('Government: Shamanism (+20% faith, +10% hides, -5% knowledge).'); break;
    case 'Meritocracy': if(S.gov){ log('A government already rules.'); break;} S.gov='Meritocracy'; S.mods.allMult*=1.05; S.mods.toolBonus=true; S.happy-=2; log('Government: Meritocracy (+5% all, +tools, -2 happiness).'); break;
    case 'Military Dictatorship': if(S.gov){ log('A government already rules.'); break;} S.gov='Military'; S.mods.allMult*=1.03; S.happy-=5; log('Government: Military Dictatorship (+3% all, -5 happiness).'); break;
    case 'Magocracy': if(S.gov){ log('A government already rules.'); break;} S.gov='Magocracy'; S.mods.manaProd*=1.30; S.mods.knowledgeBonus*=1.10; S.mods.popMult*=0.9; log('Government: Magocracy (+30% mana, +10% knowledge, -10% pop growth).'); break;
    // Victory paths
    case 'Cultural Triumph': S.won='Cultural Victory'; log('Cultural Triumph! Your arts echo across the realm.'); break;
    case 'Sacred Covenant': S.won='Religious Victory'; log('Sacred Covenant! Faith unites your people.'); break;
    case 'Trade Hegemony': S.won='Economic Victory'; log('Trade Hegemony! Your merchants rule the markets.'); break;
    case 'Scientific Enlightenment': S.won='Scientific Victory'; log('Scientific Enlightenment! Knowledge remakes society.'); break;
  }
}
function unlockTech(id){
  const node=TECH_DATA.find(t=>t.id===id); const name=node.name;
  if(nodeStatus(id)!=='available') return;
  if((S.res.knowledge||0) < node.cost){ toast("Need "+node.cost+" üìú"); return; }
  S.res.knowledge -= node.cost;
  S.techs.add(name);
  applyTechEffects(name);
  rebuildBuildListForTech(); updateResAndMeta(); renderTechTree();
}
function renderTechTree(){
  computeTechPositions();
  const canvas=$('#techCanvas'); const edges=$('#techEdges');
  canvas.innerHTML=''; edges.innerHTML='';
  const allPos=Object.values(TECH_POS_MAP);
  const width=Math.max(...allPos.map(p=>p[0]))+220;
  const height=Math.max(...allPos.map(p=>p[1]))+160;
  canvas.style.width=width+'px';
  canvas.style.height=height+'px';
  edges.setAttribute('width',width);
  edges.setAttribute('height',height);
  TECH_DATA.forEach(n=>{
    n.prereq.forEach(p=>{
      const [x1,y1]=TECH_POS_MAP[p]; const [x2,y2]=TECH_POS_MAP[n.id];
      const sx=x1+90, sy=y1+40, tx=x2, ty=y2+40;
      const path=`M ${sx},${sy} C ${sx+80},${sy} ${tx-80},${ty} ${tx},${ty}`;
      const l=document.createElementNS('http://www.w3.org/2000/svg','path');
      l.setAttribute('d',path); l.setAttribute('fill','none'); l.setAttribute('stroke','#4a5aa0'); l.setAttribute('stroke-width','2'); l.setAttribute('opacity','0.8');
      edges.appendChild(l);
    });
  });
  TECH_DATA.forEach(n=>{
    const [x,y]=TECH_POS_MAP[n.id];
    const d=document.createElement('div'); d.className='node '+nodeStatus(n.id); d.style.left=x+'px'; d.style.top=y+'px';
    const known=S.techs.has(n.name);
    const prereqNames=n.prereq.map(pid=>TECH_DATA.find(t=>t.id===pid).name);
    const unlockTxt = n.unlocks.length? 'Unlocks: '+n.unlocks.map(k=>BUILD.find(b=>b.k===k).name).join(', ') : '';
    d.innerHTML=`<h4>${n.name}</h4>
      <div class="desc">${n.desc}</div>
      <div class="small">Prereq: ${prereqNames.length?prereqNames.join(', '):'None'}</div>
      ${unlockTxt?`<div class="unlock">${unlockTxt}</div>`:''}
      <div class="cost">Cost: üìú ${n.cost}</div>
      ${known?'<div class="small">Learned</div>':'<button class="btn">Research</button>'}`;
    if(!known){
      const btn=d.querySelector('button');
      let can = nodeStatus(n.id)==='available';
      if(n.reqRes){ can = can && Object.entries(n.reqRes).every(([k,v])=> (S.res[k]||0)>=v); }
      btn.disabled = !can;
      btn.onclick=()=>unlockTech(n.id);
    }
    canvas.appendChild(d);
  });
  $('#ownedCount').textContent = [...S.techs].length;
}

// Surprise discovery
$('#btnDiscovery').onclick=()=>{
  const cost = 40 + Math.max(0, [...S.techs].length-1)*30; // founding is free baseline
  if((S.res.knowledge||0) < cost){ toast("Need "+cost+" üìú"); return; }
  const remaining = TECH.filter(t=> !S.techs.has(t.name) && t.id!=='founding' && t.effect!=='victory' && t.prereq.every(pid=>S.techs.has(TECH.find(x=>x.id===pid).name)));
  if(remaining.length===0){ toast("No available techs. Open the Tech Tree."); return; }
  const picks=[]; while(picks.length<Math.min(3,remaining.length)){ const c=remaining[Math.random()*remaining.length|0]; if(!picks.includes(c)) picks.push(c); }
  S.res.knowledge -= cost;
  const box=document.createElement('div'); box.className='bcard'; box.innerHTML='<div class="small"><b>Choose a discovery:</b></div>';
  picks.forEach(d=>{ const btn=document.createElement('button'); btn.className='btn'; btn.style="margin-top:6px"; btn.textContent=d.name+' ‚Äî '+d.desc;
    btn.onclick=()=>{ S.techs.add(d.name); applyTechEffects(d.name); box.remove(); rebuildBuildListForTech(); updateResAndMeta(); log("Discovery: "+d.name); }; box.appendChild(btn); });
  $('#techActive').after(box);
};

// Actions
function gain(o){ Object.entries(o).forEach(([k,v])=>{
  let add=v; if(k==='stone') add = Math.round(v*(S.mods.stoneForage||1));
  S.res[k]=(S.res[k]||0)+add;
}); updateResAndMeta(); updateBuildButtons(); }
function cooldown(btn,ms){
  btn.disabled=true;
  btn.dataset.cd='1';
  const base=btn.innerHTML;
  let t=Math.ceil(ms/1000);
  const show=()=>{ btn.innerHTML=base.split('<br>')[0]+`<br><span class="small">${t}s</span>`; };
  show();
  const id=setInterval(()=>{
    t--;
    if(t<=0){
      clearInterval(id);
      btn.innerHTML=base;
      btn.disabled=false;
      btn.dataset.cd='0';
      updateActionButtons();
    } else show();
  },1000);
}
function collectNode(type,gainObj,cd,msg,btn){
  const cell=S.tiles[S.avatar.y][S.avatar.x];
  if(!cell || !cell.res || cell.res.k!==type){ log('Nothing to gather here.'); return; }
  cooldown(btn,cd);
  const key=Object.keys(gainObj)[0];
  const per=gainObj[key];
  const amt=Math.min(per, cell.res.left||0);
  gain({[key]:amt});
  cell.res.left = Math.max(0, (cell.res.left||0) - amt);
  cell.res.resources = cell.res.left;
  if(cell.res.left===0){ cell.res=null; }
  redrawTiles();
  if(!S.didFirstGather){ S.didFirstGather=true; updateQuests(); }
  log(msg);
  updateActionButtons();
}
const btnWood=$('#gWood'); btnWood.addEventListener('click',()=>collectNode('tree',{wood:5},3000,'Chopped wood.',btnWood));
const btnFood=$('#gFood'); btnFood.addEventListener('click',()=>collectNode('berry',{food:5},3000,'Picked wild berries.',btnFood));
const btnStone=$('#gStone'); btnStone.addEventListener('click',()=>collectNode('stone',{stone:3},5000,'Scavenged stone.',btnStone));
const btnClay=$('#gClay'); btnClay.addEventListener('click',()=>collectNode('clay',{clay:3},5000,'Dug clay.',btnClay));
const btnFlax=$('#gFlax'); btnFlax.addEventListener('click',()=>collectNode('flax',{flax:2},6000,'Collected flax.',btnFlax));
const btnMana=$('#gMana'); btnMana.addEventListener('click',()=>collectNode('crystal',{mana:1},6000,'Harvested crystals.',btnMana));
const btnScout=$('#scout'); btnScout.addEventListener('click',()=>{ if((S.longhouseLvl||0)<2){ toast('Need War Room'); return; } scout(); cooldown(btnScout,15000); });
const btnHero=$('#hero'); btnHero.addEventListener('click',()=>{ if((S.longhouseLvl||0)<3){ toast('Need Great Hall'); return; } if((S.res.gold||0)<50|| (S.res.food||0)<20){ toast('Need 50 gold and 20 food'); return;} S.res.gold-=50; S.res.food-=20; S.heroBuffTimer=10; log('A hero visits your Great Hall (+25% production for 10 min).'); cooldown(btnHero,20000); updateResAndMeta(); });

function scout(){
  let placed=0, tries=0;
  while(placed<3 && tries<200){
    tries++;
    const x=rng()*WORLD_W|0, y=rng()*WORLD_H|0; const cell=S.tiles[y][x];
    if(cell.b || cell.res || cell.terrain==='water') continue;
    const amt=randAmt('crystal');
    cell.res={k:'crystal', left:amt, resources:amt, resourceCap:amt}; placed++;
    spawnPing(x,y); spawnGlow(x,y);
  }
  if(placed>0){ redrawTiles(); log('Scouts mark crystal outcrops on your map.'); }
}
const btnRecruit=$('#recruit');
btnRecruit.addEventListener('click',()=>{
  const cell=S.tiles[S.avatar.y][S.avatar.x];
  if(cell.b==='chief' && S.res.food>=30 && (S.res.housing||0)>S.res.pop){
    S.res.food-=30; S.res.pop+=1; lastPop=Math.floor(S.res.pop);
    log("New villager arrived (population: "+lastPop+").");
    cooldown(btnRecruit,10000);
    updateResAndMeta(); updateBuildButtons(); updateActionButtons();
  } else {
    log("Need to be at your Longhouse with food and housing.");
  }
});
$('#reset').onclick=()=>{ if(confirm("Reset?")) location.reload(); };
$('#speed').onchange=e=>{ S.speed=parseFloat(e.target.value||'1'); };

// bootstrap
buildResourceRow(); buildBuildList(); ensureMap(); redrawTiles(); centerOnAvatar();
updateResAndMeta(); updateBuildButtons(); updateActionButtons(); renderQuests();
log("World seed: "+seedStr);
log("Use arrow keys or WASD to explore and gather.");
log("Your people gather around you, awaiting guidance.");
S.speed = parseFloat(document.getElementById('speed').value||'1');
let last=performance.now();
function loop(ts){
  const dtReal=(ts-last)/1000; last=ts;
  const dtMinutes = dtReal * S.speed; if(dtMinutes>0) produce(dtMinutes);
  updateCritters(dtMinutes);
  updateResAndMeta(); updateBuildButtons(); updateActionButtons(); drawMinimap();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
