<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cozy Hamlet ‚Äî A Tiny Medieval Settlement Game</title>
<style>
  :root{
    --bg:#0f1220;
    --panel:#161a2e;
    --panel-2:#1c2140;
    --ink:#e8ecff;
    --muted:#b9c2ff;
    --accent:#9ad29a;
    --accent-2:#ffd287;
    --accent-3:#a1c7ff;
    --good:#7cd992;
    --bad:#ff8b8b;
    --gold:#ffd76a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background: radial-gradient(1200px 700px at 70% -20%, #253057 0%, transparent 60%), linear-gradient(180deg,#0b0e1a 0%, #111530 100%);
    overflow:hidden;
  }
  .wrap{
    display:grid;
    grid-template-columns: 320px 1fr 360px;
    grid-template-rows: auto 1fr auto;
    gap:10px;
    height:100%;
    padding:10px;
  }
  header, footer{
    grid-column: 1 / -1;
    background: linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
    border:1px solid #2a2f55;
    border-radius:12px;
    padding:10px 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.25) inset;
  }
  header .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{
    background: #0e1225;
    border:1px solid #2b3366;
    border-radius:999px;
    padding:6px 10px;
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:600;
    letter-spacing:.2px;
  }
  .pill small{color:var(--muted);font-weight:500;opacity:.9}
  .pill .v{color:var(--accent)}
  .pill .minus{color:var(--bad)}
  .pill .plus{color:var(--good)}
  .btn{
    background: linear-gradient(180deg,#23294d 0%, #1b2145 100%);
    border:1px solid #2b3366;
    color:var(--ink);
    padding:8px 10px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    transition:transform .05s ease, filter .15s ease;
  }
  .btn:hover{filter:brightness(1.08)}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;filter:saturate(.5)}
  .ghost{background:transparent;border-color:#37407a}
  .primary{background:linear-gradient(180deg,#3a7f5b,#306b4d);border-color:#4ea574}
  .gold{background:linear-gradient(180deg,#c3a14a,#a78733);border-color:#e6c66a}
  .danger{background:linear-gradient(180deg,#8e3b3b,#6e2e2e);border-color:#b36565}
  .panel{
    background: linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
    border:1px solid #2a2f55;
    border-radius:14px;
    padding:10px;
    box-shadow: 0 6px 20px rgba(0,0,0,.25) inset;
    overflow:auto;
  }
  h2,h3{margin:6px 0 8px 0}
  h2{font-size:18px}
  h3{font-size:15px;color:var(--muted);font-weight:700}
  .grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:8px;
  }
  .bcard{
    border:1px solid #2a2f55;
    border-radius:12px;
    padding:10px;
    background: #121631;
    display:flex;
    flex-direction:column;
    gap:6px;
    box-shadow: 0 2px 8px rgba(0,0,0,.2);
  }
  .btop{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .tag{font-size:11px;color:#c6d0ff;opacity:.8}
  .cost{font-size:12px;color:#b8c0ff}
  .count{font-weight:800;color:var(--accent);font-size:14px}
  .desc{font-size:12px;color:#cbd3ff;opacity:.9;line-height:1.3}
  .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .right{display:flex;flex-direction:column;gap:8px}
  .quest{border:1px dashed #334; border-radius:12px; padding:10px;background:#0f1330}
  .quest.done{border-style:solid;background:#121943}
  .progress{height:8px;border-radius:999px;background:#1a2146; overflow:hidden;border:1px solid #2b3366}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,#4bbf7c,#7bd9a0)}
  .village{
    position:relative;
    aspect-ratio: 16 / 9;
    border:1px solid #2a2f55;
    border-radius:14px;
    overflow:hidden;
    background: radial-gradient(800px 400px at 50% -20%, rgba(255,255,255,.08), transparent 70%), linear-gradient(180deg,#0b0f22,#141a3a);
  }
  .sky{
    position:absolute; inset:0; transition: all 1s ease;
    background: radial-gradient(900px 400px at 50% -10%, rgba(255,255,255,.12), transparent 70%);
    pointer-events:none;
  }
  .ground{
    position:absolute; inset:0; padding:8px; display:grid;
    grid-template-columns: repeat(8, 1fr); grid-auto-rows: minmax(0,1fr);
    gap:6px;
  }
  .tile{
    background: linear-gradient(180deg,#1a2840,#17223b);
    border:1px solid #24305a;
    border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    font-size:18px;
    color:#e7f2ff;
    box-shadow: 0 2px 10px rgba(0,0,0,.25) inset;
    position:relative;
  }
  .tile .label{
    position:absolute; bottom:4px; right:6px; font-size:10px; color:#c5d0ff; opacity:.8
  }
  .toast{
    position:fixed; right:12px; bottom:12px; max-width:340px; z-index:40;
    background:#101433; color:#eef; border:1px solid #2a2f55; border-radius:12px; padding:10px 12px;
    box-shadow:0 10px 30px rgba(0,0,0,.4);
  }
  .row{display:flex;align-items:center;gap:8px}
  .small{font-size:12px; color:#c7d1ff}
  .note{font-size:12px;color:#95a2ff;opacity:.9}
  .kbd{background:#0b0f24;border:1px solid #2a2f55;border-bottom-color:#1e2446;padding:2px 6px;border-radius:6px;font-weight:700}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .hidden{display:none!important}
  .sep{height:1px;background:#2a2f55;margin:6px 0}
  .warn{color:var(--accent-2)}
  .good{color:var(--good)}
  .golden{color:var(--gold)}
  .center{display:flex; align-items:center; justify-content:center; height:100%}
  .inline{display:inline-block}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="row" id="resourceRow">
      <!-- dynamic resource pills -->
    </div>
    <div class="row" style="gap:18px; margin-top:8px">
      <div class="pill"><small>Tier</small> <span id="tier" class="v">Hamlet I</span></div>
      <div class="pill"><small>Season</small> <span id="season">Spring</span></div>
      <div class="pill"><small>Day</small> <span id="dayCount">1</span></div>
      <div class="pill"><small>Time</small> <span id="timeOfDay">06:00</span></div>
      <div class="pill"><small>Happiness</small> <span id="happy" class="v">100%</span></div>
      <button class="btn ghost" id="saveBtn" title="Save (Ctrl+S)">Save</button>
      <button class="btn ghost" id="exportBtn" title="Export Save">Export</button>
      <button class="btn ghost" id="importBtn" title="Import Save">Import</button>
      <span class="note">Tip: Press <span class="kbd">?</span> for help</span>
    </div>
  </header>

  <aside class="panel" id="leftPanel">
    <h2>Actions</h2>
    <div class="grid">
      <button class="btn" id="forageWood">üå≤ Forage Wood <div class="small">+5 wood ¬∑ 5s</div></button>
      <button class="btn" id="forageFood">üçì Forage Berries <div class="small">+5 food ¬∑ 5s</div></button>
      <button class="btn" id="forageStone">ü™® Scavenge Stone <div class="small">+3 stone ¬∑ 8s</div></button>
    </div>
    <div class="sep"></div>
    <h2>Build</h2>
    <div id="buildGrid" class="grid"></div>
  </aside>

  <main class="panel">
    <div class="village">
      <div class="sky" id="sky"></div>
      <div class="ground" id="ground"></div>
    </div>
    <div class="split" style="margin-top:8px">
      <section>
        <h2>Upgrades</h2>
        <div id="upgradeList"></div>
      </section>
      <section>
        <h2>Milestones</h2>
        <div id="questList"></div>
      </section>
    </div>
  </main>

  <aside class="panel right">
    <section>
      <h2>Town Journal</h2>
      <div id="log" class="small mono" style="white-space:pre-wrap; max-height:240px; overflow:auto"></div>
    </section>
    <section>
      <h2>Policies</h2>
      <div id="policyArea" class="small"></div>
    </section>
    <section>
      <h2>Settings</h2>
      <div class="row">
        <label><input type="checkbox" id="optAutosave" checked /> Autosave</label>
        <label><input type="checkbox" id="optAnimations" checked /> Cozy Animations</label>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn gold" id="holdFestival">üéâ Hold Festival</button>
        <span class="small">Costs 40 <span class="golden">üçû</span> food ‚Üí +20% happiness for 90s</span>
      </div>
    </section>
  </aside>

  <footer>
    <div class="row" style="justify-content:space-between">
      <div class="small">Cozy Hamlet v1.0 ‚Äî single‚Äëfile demo. Built with love and üß∫ cozy vibes.</div>
      <div class="small">Keyboard: <span class="kbd">B</span> build menu focus ¬∑ <span class="kbd">G</span> gather ¬∑ <span class="kbd">S</span> save</div>
    </div>
  </footer>
</div>

<div id="toast" class="toast hidden"></div>

<!-- Import/Export modal (simple prompt) -->
<script>
  // ========= Utility =========
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const fmt = (n) => {
    if (n >= 1e9) return (n/1e9).toFixed(2) + "B";
    if (n >= 1e6) return (n/1e6).toFixed(2) + "M";
    if (n >= 1e3) return (n/1e3).toFixed(2) + "k";
    return Math.floor(n).toString();
  };
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const now = ()=> Date.now();
  const toast = (msg)=>{
    const box = document.getElementById('toast');
    box.textContent = msg;
    box.classList.remove('hidden');
    setTimeout(()=>box.classList.add('hidden'), 2200);
  };
  const log = (msg)=>{
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    el.textContent = \`[\${time}] \${msg}\n\` + el.textContent;
  }

  // ========= Game Data =========
  const RES = ["wood","stone","food","gold","faith","knowledge","culture","housing","pop"];
  const EMOJI = {wood:"üå≤", stone:"ü™®", food:"üçû", gold:"ü™ô", faith:"‚õ™", knowledge:"üìú", culture:"üé∂", housing:"üè†", pop:"üë™"};

  const SEASONS = [
    {name:"Spring", farm:1.1, mood:+5},
    {name:"Summer", farm:1.25, mood:+0},
    {name:"Autumn", farm:1.1, mood:+3},
    {name:"Winter", farm:0.55, mood:-8},
  ];

  const BUILDINGS = [
    {
      key:"woodcutter", name:"Woodcutter's Hut", icon:"ü™ì",
      desc:"Produces wood over time.",
      baseCost:{wood: 10},
      scale:1.18,
      prod:{wood: 0.6},
      tileLabel:"Hut"
    },
    {
      key:"quarry", name:"Stone Quarry", icon:"‚õèÔ∏è",
      desc:"Quarry workers chip stone steadily.",
      baseCost:{wood: 25, stone: 10},
      scale:1.20,
      prod:{stone: 0.4},
      tileLabel:"Quarry",
      req:{tier:1}
    },
    {
      key:"farm", name:"Wheat Farm", icon:"üåæ",
      desc:"Grows grain; yields vary by season.",
      baseCost:{wood: 20},
      scale:1.18,
      prod:{food: 0.7},
      tileLabel:"Farm",
      req:{tier:0}
    },
    {
      key:"cottage", name:"Cottage", icon:"üèöÔ∏è",
      desc:"Adds cozy housing for your folk.",
      baseCost:{wood: 30, stone: 10},
      scale:1.22,
      prod:{housing: 3},
      tileLabel:"Cottage",
      req:{tier:0}
    },
    {
      key:"bakery", name:"Bakery", icon:"ü•ê",
      desc:"Consumes food to bake and sell goods for gold.",
      baseCost:{wood: 60, stone: 30},
      scale:1.25,
      prod:{gold: 0.35}, // consumes food below
      consume:{food: 0.8},
      tileLabel:"Bakery",
      req:{tier:1}
    },
    {
      key:"inn", name:"Village Inn", icon:"üçª",
      desc:"A warm hearth boosts happiness and culture.",
      baseCost:{wood: 80, stone: 60, gold: 20},
      scale:1.28,
      prod:{culture: 0.15},
      mood:+6,
      tileLabel:"Inn",
      req:{tier:1}
    },
    {
      key:"chapel", name:"Chapel", icon:"‚õ™",
      desc:"Quiet prayers raise faith and spirits.",
      baseCost:{wood: 120, stone: 120, gold: 60},
      scale:1.30,
      prod:{faith: 0.25},
      mood:+4,
      tileLabel:"Chapel",
      req:{tier:2}
    },
    {
      key:"library", name:"Scribe Library", icon:"üìö",
      desc:"Scholars gather knowledge over time.",
      baseCost:{wood: 160, stone: 140, gold: 120},
      scale:1.32,
      prod:{knowledge: 0.30},
      tileLabel:"Library",
      req:{tier:2}
    },
    {
      key:"garden", name:"Herb Garden", icon:"üåø",
      desc:"Perfumed paths inspire culture and a little food.",
      baseCost:{wood: 90, stone: 40},
      scale:1.24,
      prod:{culture: 0.20, food: 0.15},
      tileLabel:"Garden",
      req:{tier:1}
    }
  ];

  const UPGRADES = [
    {key:"sharp_axes", name:"Sharp Axes", desc:"+25% wood from Woodcutters", cost:{knowledge: 15}, effect:(S)=>S.multipliers.woodcutter.wood*=1.25, req:{tier:0}},
    {key:"millstones", name:"Millstones", desc:"+20% food from Farms", cost:{knowledge: 20}, effect:(S)=>S.multipliers.farm.food*=1.20, req:{tier:1}},
    {key:"stonecut", name:"Wedge Technique", desc:"+25% stone from Quarries", cost:{knowledge: 25}, effect:(S)=>S.multipliers.quarry.stone*=1.25, req:{tier:1}},
    {key:"yeast", name:"Wild Yeast", desc:"Bakeries use 10% less food", cost:{knowledge: 35}, effect:(S)=>S.multipliers.bakery.consume_food*=0.90, req:{tier:2}},
    {key:"songbook", name:"Village Songbook", desc:"+1 culture/s per Inn", cost:{knowledge: 60}, effect:(S)=>S.flatBonus.inn.culture+=1, req:{tier:2}},
    {key:"illumination", name:"Illumination", desc:"+25% knowledge in Libraries", cost:{knowledge: 90}, effect:(S)=>S.multipliers.library.knowledge*=1.25, req:{tier:3}},
  ];

  const POLICIES = [
    {key:"green_thumb", name:"Green Thumb", a:"+15% Farm yield", b:"+10% Garden yield", pick:(S,choice)=>{
      if(choice==='A') S.policyBonuses.food+=0.15;
      else S.policyBonuses.culture+=0.10;
    }},
    {key:"stonecraft", name:"Stonecraft", a:"+20% Quarry yield", b:"-10% building stone cost", pick:(S,choice)=>{
      if(choice==='A') S.policyBonuses.stone+=0.20;
      else S.policyBonuses.costStone*=0.90;
    }},
    {key:"hospitable", name:"Hospitable", a:"+10 happiness", b:"+1 housing per Cottage", pick:(S,choice)=>{
      if(choice==='A') S.happinessBonus+=10;
      else S.flatBonus.cottage.housing+=1;
    }}
  ];

  const MILESTONES = [
    {key:"m_gather", name:"First Steps", desc:"Gather 20 wood by any means.", goal:()=>G.res.wood >= 20, reward:()=>{gain({knowledge:5}); log("Villagers jot down useful notes (+5 üìú).")}},
    {key:"m_farm", name:"Field of Wheat", desc:"Build 1 Farm.", goal:()=>G.counts.farm>=1, reward:()=>{gain({food:20});}},
    {key:"m_cottage", name:"Warm Hearths", desc:"Build 2 Cottages.", goal:()=>G.counts.cottage>=2, reward:()=>{G.happiness=clamp(G.happiness+10,0,130);}},
    {key:"m_tier2", name:"Hamlet to Village", desc:"Reach Tier II (Village)", goal:()=>G.tier>=1, reward:()=>{gain({gold:50});}},
    {key:"m_inn", name:"Song & Story", desc:"Build an Inn.", goal:()=>G.counts.inn>=1, reward:()=>{gain({culture:15});}},
    {key:"m_library", name:"Quiet Stacks", desc:"Build a Library.", goal:()=>G.counts.library>=1, reward:()=>{gain({knowledge:50});}},
  ];

  const TIER_REQS = [
    {name:"Hamlet I", need: {pop: 0}}, // start
    {name:"Village II", need: {pop: 12, food: 150, culture: 20}},
    {name:"Market Town III", need: {pop: 24, gold: 220, faith: 30}},
    {name:"Scholarly Borough IV", need: {pop: 40, knowledge: 300, culture: 120}},
  ];

  // ========= State =========
  const G = {
    res: {wood:0, stone:0, food:0, gold:0, faith:0, knowledge:0, culture:0, housing:0, pop:3},
    counts: {}, // building counts
    tier: 0,
    day: 1,
    secsIntoDay: 6*60, // start 6:00
    seasonIdx: 0,
    happiness: 100, // 0-130 cap; >100 boosts prod
    multipliers: {}, // per-building per-res
    flatBonus: {},   // per-building flat per building
    policyBonuses: {food:0, stone:0, culture:0, costStone:1},
    happinessBonus: 0,
    upgradesBought: {},
    policiesChosen: [],
    lastTick: now(),
    lastSave: now(),
    options: {autosave:true, animations:true},
    questsDone: {},
  };

  function initDerived(){
    BUILDINGS.forEach(b=>{
      G.counts[b.key]=0;
      G.multipliers[b.key]={};
      G.flatBonus[b.key]={};
      if(b.prod) Object.keys(b.prod).forEach(r=>{ G.multipliers[b.key][r]=1; G.flatBonus[b.key][r]=0; });
      if(b.consume && b.consume.food) { if(!G.multipliers[b.key].consume_food) G.multipliers[b.key].consume_food=1; }
    });
  }
  initDerived();

  // ========= Persistence =========
  const SAVE_KEY="cozy_hamlet_save_v1";
  function save(){
    G.lastSave = now();
    localStorage.setItem(SAVE_KEY, JSON.stringify(G));
    toast("Game saved.");
  }
  function load(){
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    try{
      const data = JSON.parse(raw);
      Object.assign(G, data);
      // Migrate if needed
      BUILDINGS.forEach(b=>{
        G.counts[b.key] ??= 0;
        G.multipliers[b.key] ??= {};
        G.flatBonus[b.key] ??= {};
        if(b.prod) Object.keys(b.prod).forEach(r=>{
          G.multipliers[b.key][r] ??= 1;
          G.flatBonus[b.key][r] ??= 0;
        });
        if(b.consume && b.consume.food) { G.multipliers[b.key].consume_food ??= 1; }
      });
      G.policyBonuses ||= {food:0, stone:0, culture:0, costStone:1};
      G.upgradesBought ||= {};
      G.policiesChosen ||= [];
      G.options ||= {autosave:true, animations:true};
      G.questsDone ||= {};
      return true;
    }catch(e){ console.warn("Load failed", e); return false; }
  }
  function exportSave(){
    const blob = new Blob([localStorage.getItem(SAVE_KEY)||""], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "cozy_hamlet_save.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function importSave(){
    const json = prompt("Paste save JSON here:");
    if(!json) return;
    localStorage.setItem(SAVE_KEY, json);
    if(load()){ toast("Save imported. Reloading‚Ä¶"); setTimeout(()=>location.reload(), 500); }
    else toast("Import failed.");
  }

  // ========= UI: Resources =========
  function ensureResourceRow(){
    const row = document.getElementById('resourceRow');
    row.innerHTML = "";
    const order = ["wood","stone","food","gold","faith","knowledge","culture","housing","pop"];
    order.forEach(k=>{
      const wrap = document.createElement('div');
      wrap.className = "pill";
      wrap.title = k.toUpperCase();
      wrap.innerHTML = \`\${EMOJI[k]} <strong id="r_\${k}">0</strong> <small>\${k}</small>\`;
      row.appendChild(wrap);
    });
  }

  // ========= UI: Build Cards =========
  function costText(cost){
    return Object.entries(cost).map(([k,v])=>\`\${EMOJI[k]||""} \${Math.floor(v)} \${k}\`).join(" ¬∑ ");
  }
  function priceFor(b){
    const base = {...b.baseCost};
    const n = G.counts[b.key]||0;
    const scale = b.scale||1.2;
    for(const k in base){
      base[k] = Math.floor(base[k] * Math.pow(scale, n) * (k==="stone" ? (G.policyBonuses.costStone||1) : 1));
    }
    return base;
  }
  function canAfford(cost){
    return Object.entries(cost).every(([k,v])=> (G.res[k]||0) >= v);
  }
  function pay(cost){
    Object.entries(cost).forEach(([k,v])=> G.res[k]-=v);
  }
  function buildCard(b){
    const c = document.createElement('div');
    c.className = "bcard";
    c.innerHTML = \`
      <div class="btop">
        <div class="flex"><div style="font-size:20px">\${b.icon}</div><div><strong>\${b.name}</strong><div class="tag">\${b.desc}</div></div></div>
        <div class="count" id="count_\${b.key}">0</div>
      </div>
      <div class="cost" id="cost_\${b.key}"></div>
      <div class="flex">
        <button class="btn primary" id="buy_\${b.key}">Build</button>
        <button class="btn ghost" id="info_\${b.key}">Info</button>
      </div>
    \`;
    return c;
  }
  function refreshBuildGrid(){
    const grid = document.getElementById('buildGrid');
    grid.innerHTML="";
    BUILDINGS.forEach(b=>{
      // Unlock check by tier
      if(b.req && (b.req.tier??0) > G.tier) return;
      const card = buildCard(b);
      grid.appendChild(card);
      const price = priceFor(b);
      document.getElementById('cost_'+b.key).textContent = "Cost: " + costText(price);
      document.getElementById('count_'+b.key).textContent = G.counts[b.key]||0;
      const btn = document.getElementById('buy_'+b.key);
      btn.disabled = !canAfford(price);
      btn.onclick = ()=>{
        const p = priceFor(b);
        if(!canAfford(p)) return;
        pay(p);
        G.counts[b.key] = (G.counts[b.key]||0)+1;
        placeTile(b);
        log(\`Built \${b.name}.\`);
        refreshAll();
      };
      $('#info_'+b.key).onclick = ()=>{
        alert(\`\${b.name}\n\n\${b.desc}\n\nProduces: \${b.prod ? Object.entries(b.prod).map(([k,v])=>\`\${EMOJI[k]} +\${v}/s\`).join(", ") : "‚Äî"}\nMood: \${b.mood? (b.mood>0?"+":"") + b.mood : "‚Äî"}\`);
      };
    });
  }

  // ========= UI: Village Grid =========
  const GRID_W=8, GRID_H=6;
  function ensureGrid(){
    const g = document.getElementById('ground');
    g.innerHTML="";
    for(let i=0;i<GRID_W*GRID_H;i++){
      const t = document.createElement('div');
      t.className="tile";
      t.dataset.idx=i;
      t.innerHTML = '<span class="label"></span>';
      g.appendChild(t);
    }
  }
  function freeTile(){
    const tiles = $$('.tile');
    for(const t of tiles){ if(!t.dataset.b) return t; }
    return null;
  }
  function placeTile(b){
    const t = freeTile();
    if(!t) return;
    t.dataset.b = b.key;
    t.innerHTML = \`<div>\${b.icon}</div><div class="label">\${b.tileLabel||b.name}</div>\`;
  }
  function rebuildTilesFromCounts(){
    ensureGrid();
    // Build order: render per building count
    BUILDINGS.forEach(b=>{
      const n = G.counts[b.key]||0;
      for(let i=0;i<n;i++) placeTile(b);
    });
  }

  // ========= Upgrades =========
  function refreshUpgrades(){
    const el = document.getElementById('upgradeList');
    el.innerHTML="";
    UPGRADES.forEach(u=>{
      if(u.req && (u.req.tier??0) > G.tier) return;
      const owned = !!G.upgradesBought[u.key];
      const row = document.createElement('div');
      row.className="row";
      row.style="justify-content:space-between;border:1px solid #2a2f55;border-radius:10px;padding:8px;margin-bottom:6px;background:#0f1435;";
      row.innerHTML = \`
        <div>
          <strong>\${owned?"‚úÖ ":""}\${u.name}</strong>
          <div class="small">\${u.desc}</div>
        </div>
        <div class="row">
          <div class="small">\${ owned ? "Purchased" : "Cost: "+costText(u.cost)}</div>
          <button class="btn" \${owned?"disabled":""} id="buyU_\${u.key}">\${owned?"Owned":"Buy"}</button>
        </div>
      \`;
      el.appendChild(row);
      if(!owned){
        $('#buyU_'+u.key).onclick=()=>{
          if(!canAfford(u.cost)) return;
          pay(u.cost);
          u.effect(G);
          G.upgradesBought[u.key]=1;
          log(\`Upgrade: \${u.name}.\`);
          refreshAll();
        };
      }
    });
  }

  // ========= Policies (choose A/B once per policy) =========
  function refreshPolicies(){
    const area = document.getElementById('policyArea');
    area.innerHTML="";
    POLICIES.forEach((p,i)=>{
      const chosen = G.policiesChosen[i] || null;
      const box = document.createElement('div');
      box.className="bcard";
      box.innerHTML = \`
        <div class="btop"><div><strong>\${p.name}</strong></div><div class="tag">\${chosen? "Chosen: "+chosen : "Pick one"}</div></div>
        <div class="split">
          <button class="btn \${chosen?"ghost":""}" id="pol_\${i}_A" \${chosen?"disabled":""}>A) \${p.a}</button>
          <button class="btn \${chosen?"ghost":""}" id="pol_\${i}_B" \${chosen?"disabled":""}>B) \${p.b}</button>
        </div>
      \`;
      area.appendChild(box);
      if(!chosen){
        $('#pol_'+i+'_A').onclick=()=>{ p.pick(G,'A'); G.policiesChosen[i]='A'; log(\`Policy \${p.name}: Option A.\`); refreshAll(); };
        $('#pol_'+i+'_B').onclick=()=>{ p.pick(G,'B'); G.policiesChosen[i]='B'; log(\`Policy \${p.name}: Option B.\`); refreshAll(); };
      }
    });
  }

  // ========= Quests / Milestones =========
  function refreshQuests(){
    const el = document.getElementById('questList');
    el.innerHTML="";
    MILESTONES.forEach(m=>{
      const done = !!G.questsDone[m.key];
      const q = document.createElement('div');
      q.className = "quest"+(done?" done":"");
      const prog = done ? 1 : (m.goal()?1:0);
      q.innerHTML = \`
        <div class="row" style="justify-content:space-between">
          <div><strong>\${m.name}</strong><div class="small">\${m.desc}</div></div>
          <div class="small \${done?"good":""}">\${done?"Done":"In progress"}</div>
        </div>
        <div class="progress"><div class="bar" style="width:\${prog*100}%"></div></div>
      \`;
      el.appendChild(q);
      if(!done && m.goal()){
        G.questsDone[m.key]=1;
        m.reward&&m.reward();
        toast(\`Milestone: \${m.name} completed!\`);
      }
    });
  }

  // ========= Game Loop =========
  function season(){ return SEASONS[G.seasonIdx % SEASONS.length]; }
  function seasonFarmMult(){ return season().farm; }

  function perSecondProduction(){
    const prod = {wood:0, stone:0, food:0, gold:0, faith:0, knowledge:0, culture:0, housing:0};
    BUILDINGS.forEach(b=>{
      const n = G.counts[b.key]||0; if(!n) return;
      if(b.prod){
        for(const k in b.prod){
          let base = b.prod[k] * n;
          // apply season to food from farms
          if(b.key==="farm" && k==="food") base *= seasonFarmMult();
          // per-building multipliers & flat bonus
          base *= (G.multipliers[b.key][k]||1);
          base += (G.flatBonus[b.key][k]||0) * n;
          prod[k] = (prod[k]||0) + base;
        }
      }
    });
    // Bakery consumption/production
    const bakeries = G.counts.bakery||0;
    if(bakeries>0){
      const consumeRate = 0.8 * bakeries * (G.multipliers.bakery.consume_food||1);
      if(G.res.food >= consumeRate){ // can run full
        prod.food -= consumeRate;
        prod.gold += (BUILDINGS.find(b=>b.key==="bakery").prod.gold) * bakeries * (G.multipliers.bakery.gold||1);
      } else if(G.res.food>0){ // partial
        const ratio = G.res.food / consumeRate;
        prod.food -= G.res.food; // use all food
        prod.gold += (BUILDINGS.find(b=>b.key==="bakery").prod.gold) * bakeries * ratio * (G.multipliers.bakery.gold||1);
      }
    }

    // Policy resource bonuses
    if(G.policyBonuses.food) prod.food *= (1+G.policyBonuses.food);
    if(G.policyBonuses.stone) prod.stone *= (1+G.policyBonuses.stone);
    if(G.policyBonuses.culture) prod.culture *= (1+G.policyBonuses.culture);

    // Happiness multiplier (0-130 -> 0.7x .. 1.3x roughly)
    const happyFactor = 0.7 + clamp((G.happiness-50)/100, -0.3, 0.8);
    for(const k of ["wood","stone","food","gold","faith","knowledge","culture"]){
      prod[k] *= happyFactor;
    }
    return prod;
  }

  function tick(dtSeconds){
    // Time & season
    G.secsIntoDay += dtSeconds;
    if(G.secsIntoDay >= 24*60){ G.secsIntoDay -= 24*60; G.day++; if(G.day%6===1){ G.seasonIdx=(G.seasonIdx+1)%SEASONS.length; log("Season is now "+season().name+"."); G.happiness += season().mood; } }

    // Population grows if spare housing and food
    const spare = (G.res.housing||0) - (G.res.pop||0);
    if(spare > 0 && G.res.food > 20){
      G.res.pop = Math.min(G.res.pop + dtSeconds*0.02, (G.res.housing||0));
    }
    // Hunger lowers happiness slowly if food is near 0
    if(G.res.food < 5) G.happiness -= dtSeconds*0.5;
    else G.happiness += dtSeconds*0.15;
    G.happiness = clamp(G.happiness + (G.happinessBonus||0)*0.0001, 0, 130);

    // Production
    const ps = perSecondProduction();
    for(const k in ps){
      G.res[k] = (G.res[k]||0) + ps[k]*dtSeconds;
    }
    // Housing is not cumulative per second; ensure housing equals sum of providers
    const staticHousing = (()=>{
      let h=0;
      BUILDINGS.forEach(b=>{
        if((G.counts[b.key]||0)>0 && b.prod && b.prod.housing){
          const per = b.prod.housing*(G.multipliers[b.key].housing||1) + (G.flatBonus[b.key].housing||0);
          h += per * (G.counts[b.key]||0);
        }
      });
      return h;
    })();
    G.res.housing = staticHousing;

    // Tier progression check
    checkTier();
  }

  function checkTier(){
    const req = TIER_REQS[G.tier+1];
    if(!req) return;
    const ok = Object.entries(req.need).every(([k,v])=> (G.res[k]||0) >= v);
    if(ok){
      G.tier++;
      toast(\`Your settlement advanced to \${TIER_REQS[G.tier].name}!\`);
      log(\`Tier up ‚Üí \${TIER_REQS[G.tier].name}.\`);
      // On each tier up, offer a policy choice if available and not yet chosen
      refreshPolicies();
    }
  }

  // ========= Render =========
  function pad(n){return String(n).padStart(2,'0')}
  function render(){
    // Resources
    RES.forEach(k=>{
      $('#r_'+k).textContent = fmt(G.res[k]||0);
    });
    $('#happy').textContent = Math.round(G.happiness) + "%";

    // Time badges
    $('#tier').textContent = TIER_REQS[G.tier].name;
    $('#season').textContent = season().name;
    $('#dayCount').textContent = G.day.toString();
    const minutes = Math.floor(G.secsIntoDay%60);
    const hours = Math.floor(G.secsIntoDay/60)%24;
    $('#timeOfDay').textContent = pad(hours) + ":" + pad(minutes);

    // Sky tint by time
    const sky = $('#sky');
    const t = (G.secsIntoDay%(24*60))/(24*60);
    const isNight = t<0.22 || t>0.78;
    sky.style.background = isNight
      ? "radial-gradient(900px 400px at 50% -10%, rgba(255,255,255,.05), transparent 70%), linear-gradient(180deg,#091023,#0b0f22)"
      : "radial-gradient(900px 400px at 50% -10%, rgba(255,255,255,.14), transparent 70%), linear-gradient(180deg,#1a2450,#0f1434)";

    // Build cards
    refreshBuildGrid();
    // Upgrades
    refreshUpgrades();
    // Quests
    refreshQuests();
  }

  function refreshAll(){
    render();
  }

  // ========= Input & Actions =========
  function gain(obj){ Object.entries(obj).forEach(([k,v])=> G.res[k]=(G.res[k]||0)+v); refreshAll(); }
  function cooldown(btn, ms){
    btn.disabled = true;
    const txt = btn.textContent;
    let left = ms;
    const id = setInterval(()=>{
      left-=1000;
      btn.textContent = txt + " ("+Math.ceil(left/1000)+"s)";
      if(left<=0){ clearInterval(id); btn.disabled=false; btn.textContent = txt; }
    }, 1000);
  }

  function initControls(){
    $('#forageWood').onclick = (e)=>{ gain({wood:5}); cooldown(e.target, 5000); log("Villagers gathered fallen branches."); };
    $('#forageFood').onclick = (e)=>{ gain({food:5}); cooldown(e.target, 5000); log("Baskets filled with berries."); };
    $('#forageStone').onclick = (e)=>{ gain({stone:3}); cooldown(e.target, 8000); log("Useful stones collected."); };

    $('#saveBtn').onclick = save;
    $('#exportBtn').onclick = exportSave;
    $('#importBtn').onclick = importSave;

    $('#optAutosave').checked = G.options.autosave;
    $('#optAnimations').checked = G.options.animations;
    $('#optAutosave').onchange = (e)=> G.options.autosave = e.target.checked;
    $('#optAnimations').onchange = (e)=> document.body.style.transition = e.target.checked ? "" : "none";

    $('#holdFestival').onclick = ()=>{
      if(G.res.food < 40) { toast("Not enough food for a festival."); return; }
      G.res.food -= 40;
      const add = 20;
      G.happiness = clamp(G.happiness + add, 0, 130);
      log("A merry festival lifts everyone's spirits!");
    };

    // Hotkeys
    window.addEventListener('keydown', (e)=>{
      if(e.key==='s' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); save(); }
      if(e.key==='g'){ e.preventDefault(); $('#forageWood').click(); }
      if(e.key==='b'){ e.preventDefault(); $('#leftPanel').scrollIntoView({behavior:'smooth'}); }
      if(e.key==='?'){ e.preventDefault(); alert("Cozy Hamlet ‚Äî Controls:\n\n‚Ä¢ Click Actions to gather starting resources.\n‚Ä¢ Build cards unlock as you advance tiers.\n‚Ä¢ Upgrades spend üìú Knowledge for better yields.\n‚Ä¢ Policies: pick one of two ‚Äî permanent.\n‚Ä¢ Hold Festivals to boost happiness.\n‚Ä¢ Autosave can be toggled in Settings.\n\nEnjoy the cozy vibes!"); }
    });
  }

  // ========= Bootstrap =========
  function firstRun(){
    ensureResourceRow();
    ensureGrid();
    rebuildTilesFromCounts();
    refreshPolicies();
    initControls();
    refreshAll();
  }

  // Offline progress
  function applyOfflineProgress(){
    const dt = Math.min(60*60*12, Math.max(0, (now() - (G.lastSave||now()))/1000)); // cap 12h
    if(dt>5){
      // simulate in chunks to keep stability
      let left = dt;
      const step = 5;
      while(left>0){
        const d = Math.min(step, left);
        tick(d);
        left -= d;
      }
      toast("Your villagers worked while you were away (+offline progress).");
    }
  }

  if(!load()){
    // New game seed
    gain({wood: 20, food: 15, stone: 5});
    log("A few families settle by a creek. A cozy hamlet is born.");
  }
  firstRun();
  applyOfflineProgress();

  // Main loop
  let last = now();
  function loop(){
    const t = now();
    const dt = Math.min(0.25, (t-last)/1000);
    last = t;
    tick(dt);
    render();
    if(G.options.autosave && (t - G.lastSave) > 20000){ save(); }
    requestAnimationFrame(loop);
  }
  loop();
</script>
</body>
</html>
